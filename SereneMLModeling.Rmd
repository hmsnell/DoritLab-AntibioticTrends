---
title: "SereneMLModeling"
author: "Serene Lee"
output: html_document
---

```{r}
library(tidyverse)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)

#For SAS:
install.packages("haven")
require(haven)

IsolateData_6 <- read.csv("IsolateData-6.csv")

```


# Parsing:
```{r}
#IsolateData_6 %>%
#  IsolateData_6$Region.Name <- as.character(Region.Name) %>%
#  select(Region.Name)

IsolateData_6$Region.Name <- as.character(IsolateData_6$Region.Name)

isolate_RegionFreq <- IsolateData_6 %>% 
  select(Region.Name) %>%
  filter(Region.Name == "Region 1",
         Region.Name == "Region 2",
         Region.Name == "Region 3",
         Region.Name == "Region 4",
         Region.Name == "Region 5",
         Region.Name == "Region 6",
         Region.Name == "Region 7",
         Region.Name == "Region 8",
         Region.Name == "Region 9",
         Region.Name == "Region 10")# %>% 
#  group_by(`Region.Name`) %>% 
#  mutate(count = n())

```

# Sample Source: Blood, Stool, Urine, Gall Bladder, CSF, Wound
```{r}
# Blood Sample
isolate_Blood <- IsolateData_6 %>% 
  filter(Specimen.Source == "Blood") %>% 
  group_by(`Resistance.Pattern`) %>% 
  mutate(ResistCount = n()) %>% 
  filter(ResistCount >= 100) %>% 
  mutate(logResist = log10(ResistCount))

  
Blood <- ggplot(data = isolate_Blood, aes(x = `Resistance.Pattern`, y = logResist)) + geom_col() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("Blood Sample")
Blood

# Stool Sample
isolate_Stool <- IsolateData_6 %>% 
  filter(Specimen.Source == "Stool") %>% 
  group_by(`Resistance.Pattern`) %>% 
  mutate(ResistCount = n()) %>% 
  filter(ResistCount >= 100) %>% 
  mutate(logResist = log10(ResistCount))

  
Stool <- ggplot(data = isolate_Stool, aes(x = `Resistance.Pattern`, y = logResist)) + geom_col() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("Stool Sample")
Stool

# Urine Sample
isolate_Urine <- IsolateData_6 %>% 
  filter(Specimen.Source == "Urine") %>% 
  group_by(`Resistance.Pattern`) %>% 
  mutate(ResistCount = n()) %>% 
  filter(ResistCount >= 100) %>% 
  mutate(logResist = log10(ResistCount))

  
Urine <- ggplot(data = isolate_Urine, aes(x = `Resistance.Pattern`, y = logResist)) + geom_col() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("Urine Sample")
Urine

#Gall Bladder Sample
isolate_GBladder <- IsolateData_6 %>% 
  filter(Specimen.Source == "Gall Bladder") %>% 
  group_by(`Resistance.Pattern`) %>% 
  mutate(ResistCount = n()) #%>% 
#  filter(ResistCount >= 100) %>% 
#  mutate(logResist = log10(ResistCount))

  
GBladder <- ggplot(data = isolate_GBladder, aes(x = `Resistance.Pattern`, y = ResistCount)) + geom_col() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("Gall Bladder Sample")
GBladder

#CSF Sample (Cerebrospinal fluid)
isolate_CSF <- IsolateData_6 %>% 
  filter(Specimen.Source == "CSF") %>% 
  group_by(`Resistance.Pattern`) %>% 
  mutate(ResistCount = n()) #%>% 
#  filter(ResistCount >= 100) %>% 
#  mutate(logResist = log10(ResistCount))

  
CSF <- ggplot(data = isolate_CSF, aes(x = `Resistance.Pattern`, y = ResistCount)) + geom_col() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("CSF Sample")
CSF

#Wound Sample
isolate_Wound <- IsolateData_6 %>% 
  filter(Specimen.Source == "Wound") %>% 
  group_by(`Resistance.Pattern`) %>% 
  mutate(ResistCount = n()) #%>% 
#  filter(ResistCount >= 100) %>% 
#  mutate(logResist = log10(ResistCount))

  
Wound <- ggplot(data = isolate_Wound, aes(x = `Resistance.Pattern`, y = ResistCount)) + geom_col() + theme(axis.text.x = element_text(angle = 90)) + ggtitle("Wound Sample")
Wound
  
```


#Loading Antibiotic Use Data:
```{r}
Antibiotic_Use <- read.csv("Outpatient_Antibiotic_Use.csv")

WhichYear <- Antibiotic_Use %>%
  filter(Sex == "Combined Gender",
         Rate != "Insufficient Data",
         Antibiotic_Class != "All classes") #%>%
#  group_by(Year) %>%
#  summarise(count = n())
```


#Jejuni Collapse Data:
```{r}
## Filtering for ONLY 2011 b/c it has the most observations from the Isolate Dataset
Jejuni_IsolateData <- IsolateData_6 %>%
  filter(Species == "jejuni", 
         Resistance.Pattern == "CipNal" |
         Resistance.Pattern == "Cli" |
         Resistance.Pattern == "T" |
         Resistance.Pattern == "TCipNal" |
         Resistance.Pattern == "TCipNalCli" |
         Resistance.Pattern == "TCli") %>%
  group_by(Data.Year) %>%
  summarise(count = n())
```

# CMS Data - Medicaid/Medicare
```{r}
library(dplyr)
library(ggplot2)

Medicaid_FilteredMeth <- Medicaid_SpendingUtilization %>%
  filter(GenericName == "Meth/Meblue/Sod Phos/Psal/Hyos")

ggplot(data = Medicaid_SpendingUtilization, aes(x = Year, y = TotalSpending)) + geom_point()

ggplot(data = Medicaid_FilteredMeth, aes(x = Year, y = TotalSpending, col = BrandName)) + geom_point()
ggplot(data = Medicaid_FilteredMeth, aes(x = Year, y = TotalClaims, col = BrandName)) + geom_line()
```

#Medicaid:
##Quinolones/Fluoroquinolones antibiotic drugs:
```{r}
#Generic name of drug (Referenced GoodRx): Ciprofloxacin HCl, Ciprofloxacin, Ciprofloxacin/Hydrocortisone,
#Ciprofloxacin In 5 % Dextrose, Ciprofloxacin HCl/Dexameth, Ciprofloxacin Lactate, Ciprofloxacin/Ciprofloxa HCl, Ciprofloxacin HCl/Fluocinolone, Levofloxacin, Levofloxacin In Dextrose 5 %, Ofloxacin, Moxifloxacin HCl, Moxifloxacin-Sod.Chloride(Iso), Moxifloxacin/Sod.Ace,Sul/Water, Besifloxacin HCl, Delafloxacin Meglumine, Gatifloxacin

# Create a new data set with only drugs under the quinolones antibiotic class:
Medicaid_Quinolone <- Medicaid_SpendingUtilization %>%
  filter(GenericName == "Ciprofloxacin HCl"|
           GenericName == "Ciprofloxacin"|
           GenericName == "Ciprofloxacin/Hydrocortisone"|
           GenericName == "Ciprofloxacin In 5 % Dextrose"|
           GenericName == "Ciprofloxacin HCl/Dexameth"|
           GenericName == "Ciprofloxacin Lactate"|
           GenericName == "Ciprofloxacin/Ciprofloxa HCl"|
           GenericName == "Ciprofloxacin HCl/Fluocinolone"|
           GenericName == "Levofloxacin"|
           GenericName == "Levofloxacin In Dextrose 5 %"|
           GenericName == "Ofloxacin"|
           GenericName == "Moxifloxacin HCl"|
           GenericName == "Moxifloxacin-Sod.Chloride(Iso)"|
           GenericName == "Moxifloxacin/Sod.Ace,Sul/Water"|
           GenericName == "Besifloxacin HCl"|
           GenericName == "Delafloxacin Meglumine"|
           GenericName == "Gatifloxacin")
View(Medicaid_Quinolone)

# EDA to look at trends for spending:
ggplot(data = Medicaid_Quinolone, aes(x = Year, y = TotalSpending)) + geom_point()
ggplot(data = Medicaid_Quinolone, aes(x = Year, y = TotalClaims, col = GenericName)) + geom_jitter()
ggplot(data = Medicaid_Quinolone, aes(x = log10(TotalClaims))) + geom_histogram() + facet_wrap(~Year)
```


#Regional Resistance Data:
```{r}
# Refreshing Regional resistance data
Resist_Regional <- resistance_region %>%
  select(-Lower95CI, -Upper95CI, -PercentResistant)

#Resistance Trends by Region
Resist_Regional <- Resist_Regional %>%
  filter(NumberResistant != "Insufficient Data" & NumberResistant != "None Tested" & EventYear != "All Years")

#Change data type
Resist_Regional$NumberTested <- as.numeric(as.character(Resist_Regional$NumberTested))
Resist_Regional$NumberResistant <- as.numeric(as.character(Resist_Regional$NumberResistant))
#Resist_Regional$PercentResistant <- as.numeric(as.character(Resist_Regional$PercentResistant))
Resist_Regional$AgeCategory <- as.character(Resist_Regional$AgeCategory)

# Plot to see trends in region:
#ggplot(data = Resist_Regional, aes(x = EventYear, y = PercentResistant, col = AgeCategory)) + geom_col()
#ggplot(data = Resist_Regional, aes(x = EventYear, y = PercentResistant)) + geom_col() + facet_wrap(~Region)

```

# Calculate Percent Resistant
```{r}
# Tidy format for Resist_Regional data and take out ALL HAIS and ALL AGES
Resist_Regional <- Resist_Regional %>%
  gather(MetricType, MetricNumber, NumberTested:NumberResistant) %>%
  filter(EventType != "All HAIs", AgeCategory != "All Ages")

# Plot NumberTested and NumberResistant Data
ggplot(data = Resist_Regional, 
       aes(x = EventYear, y = MetricNumber, fill = MetricType)) + 
  geom_col(position = position_dodge(width = 0.5)) + 
  facet_wrap(~Region)

# Regroup data for Calculated PercentResistant Data
Resist_Regional_CalculateResPercent <- Resist_Regional %>%
  group_by(Region, EventYear, MetricType) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

# Revert Dataset to Wide form
Wide_data_ResistPercent <- spread(Resist_Regional_CalculateResPercent,
                                  MetricType,
                                  TotalMetricNumber)
Wide_data_ResistPercent <- Wide_data_ResistPercent %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)

#Wide_data_ResistPercent <- melt(Resist_Regional_CalculateResPercent,
#                                id.vars = c("Region", "EventYear"),
#                                variable.name = "MetricType",
#                                value.name = "TotalMetricNumber")

#Wide_data_ResistPercent <- reshape(Resist_Regional_CalculateResPercent,
#                                   idvar = c("Region", "EventYear"),
#                                   timevar = "MetricType",
#                                   direction = "wide")

# Plot Percent Resistant Data
ggplot(data = Wide_data_ResistPercent, 
       aes(x = EventYear, y = Percent_Resistant)) + 
  geom_col() + 
  facet_wrap(~Region)

# Facet with Years
  
```

#Trying other variables: Age Category
```{r}
#Regroup Resist_Regional by AgeCategory:
Resist_Regional <- resistance_region %>%
  select(-Lower95CI, -Upper95CI, -PercentResistant)

#Resistance Trends by Region
Resist_Regional <- Resist_Regional %>%
  filter(NumberResistant != "Insufficient Data" & NumberResistant != "None Tested" & EventYear != "All Years")

#Change data type to numerical
Resist_Regional$NumberTested <- as.numeric(as.character(Resist_Regional$NumberTested))
Resist_Regional$NumberResistant <- as.numeric(as.character(Resist_Regional$NumberResistant))

# Tidy format for Resist_Regional data 
Resist_Regional <- Resist_Regional %>%
  gather(MetricType, MetricNumber, NumberTested:NumberResistant) %>%
  filter(EventType != "All HAIs", AgeCategory != "All Ages")

# Regroup with age and year
Resist_Regional_byAge <- Resist_Regional %>%
  group_by(Region, EventYear, MetricType, AgeCategory) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

# Revert Dataset to Wide form
Wide_AgeCategory <- spread(Resist_Regional_byAge,
                                  MetricType,
                                  TotalMetricNumber)
Wide_AgeCategory <- Wide_AgeCategory %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)

# Plot Percent Resistance by AgeCaetgory (bar):
ggplot(data = Wide_AgeCategory, 
       aes(x = EventYear, y = Percent_Resistant, fill = AgeCategory)) + 
  geom_col(position = "dodge") + 
  facet_wrap(~Region)

# Plot Percent Resistance by AgeCaetgory (line):
Resist_Regional_byAge <- Resist_Regional %>%
  group_by(EventYear, MetricType, AgeCategory) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

Wide_AgeCategory <- spread(Resist_Regional_byAge,
                                  MetricType,
                                  TotalMetricNumber)
Wide_AgeCategory <- Wide_AgeCategory %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)

Wide_AgeCategory <- Wide_AgeCategory %>%
  filter(Percent_Resistant != 0)

ggplot(data = Wide_AgeCategory, 
       aes(x = EventYear, y = Percent_Resistant, col = AgeCategory)) + 
  geom_line() #Don't know why it's not plotting



```

#Trying out some statistical tests
```{r}
# Chi Square:
# categorical variables: Phenotype, Region, EventType, EventYear, EventCategory


#Regroup Resist_Regional by AgeCategory:
Resist_Regional <- resistance_region %>%
  select(-Lower95CI, -Upper95CI, -PercentResistant)

#Resistance Trends by Region
Resist_Regional <- Resist_Regional %>%
  filter(NumberResistant != "Insufficient Data" & NumberResistant != "None Tested" & EventYear != "All Years")

#Change data type to numerical
Resist_Regional$NumberTested <- as.numeric(as.character(Resist_Regional$NumberTested))
Resist_Regional$NumberResistant <- as.numeric(as.character(Resist_Regional$NumberResistant))

# Tidy format for Resist_Regional data 
Resist_Regional <- Resist_Regional %>%
  gather(MetricType, MetricNumber, NumberTested:NumberResistant) %>%
  filter(EventType != "All HAIs", AgeCategory != "All Ages")


#Rearrange
Resist_Regional_test <- Resist_Regional %>%
  group_by(Phenotype, Region, MetricType, AgeCategory) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

# Revert Dataset to Wide form
Wide_test <- spread(Resist_Regional_test,
                                  MetricType,
                                  TotalMetricNumber)
Wide_test <- Wide_test %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)


```

Load SAS files
```{r}

```
















