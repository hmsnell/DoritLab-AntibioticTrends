---
title: "SereneMLModeling"
author: "Serene Lee"
output: html_document
---

```{r}
install.packages("vroom")

library(tidyverse)
library(tidyr)
library(reshape2)
library(ggplot2)
library(dplyr)
library(stringr)
library(readxl)
library(vroom)
#Unique values from partd_antibioticgeneric:
PARTD_AntibioticGeneric <- read_excel("Data/PARTD_AntibioticGeneric.xlsx")
PARTD_AntibioticGeneric[!duplicated(PARTD_AntibioticGeneric$`Generic Name`), ]

#Unique values from PARTD_AP (Antipsychotic drugs):
PARTD_AP <- read_excel("Data/PARTD_AP.xlsx")
PARTD_AP <- PARTD_AP[!duplicated(PARTD_AP$`Generic_Name_AP`), ]
```

ANTIBIOTICS

IMPORTING DATAFRAMES
```{r}
#2013
iqvia13 <- read.delim("~/Desktop/PartD_Prescriber_PUF_NPI_Drug_13.txt")
#Parse 2013
iqvia13_1 <- iqvia13 %>% 
  slice(1:5000000)
iqvia13_2 <- iqvia13 %>% 
  slice(5000001:10000000) 
iqvia13_3 <- iqvia13 %>% 
  slice(10000001:15000000) 
iqvia13_4 <- iqvia13 %>% 
  slice(15000001:20000000)
iqvia13_5 <- iqvia13 %>% 
  slice(20000001:23645873)
#Export .csv files
write.csv(iqvia13_1,"~/Desktop/iqvia13_1.csv")
write.csv(iqvia13_2,"~/Desktop/iqvia13_2.csv")
write.csv(iqvia13_3,"~/Desktop/iqvia13_3.csv")
write.csv(iqvia13_4,"~/Desktop/iqvia13_4.csv")
write.csv(iqvia13_5,"~/Desktop/iqvia13_5.csv")

#Delete Data environment to restore data storage

#2014
iqvia14 <- read.delim("~/Desktop/PartD_Prescriber_PUF_NPI_Drug_14.txt")
#Parse 2014
iqvia14_1 <- iqvia14 %>% 
  slice(1:5000000)
iqvia14_2 <- iqvia14 %>% 
  slice(5000001:10000000) 
iqvia14_3 <- iqvia14 %>% 
  slice(10000001:15000000) 
iqvia14_4 <- iqvia14 %>% 
  slice(15000001:20000000)
iqvia14_5 <- iqvia14 %>% 
  slice(20000001:24120618)
#Export .csv files
write.csv(iqvia14_1,"~/Desktop/iqvia14_1.csv")
write.csv(iqvia14_2,"~/Desktop/iqvia14_2.csv")
write.csv(iqvia14_3,"~/Desktop/iqvia14_3.csv")
write.csv(iqvia14_4,"~/Desktop/iqvia14_4.csv")
write.csv(iqvia14_5,"~/Desktop/iqvia14_5.csv")

#Delete Data environment to restore data storage

#2015
iqvia15 <- read.delim("~/Desktop/PartD_Prescriber_PUF_NPI_Drug_15.txt")
#Parse 2015
iqvia15_1 <- iqvia15 %>% 
  slice(1:5000000)
iqvia15_2 <- iqvia15 %>% 
  slice(5000001:10000000) 
iqvia15_3 <- iqvia15 %>% 
  slice(10000001:15000000) 
iqvia15_4 <- iqvia15 %>% 
  slice(15000001:20000000)
iqvia15_5 <- iqvia15 %>% 
  slice(20000001:24524894)
#Export .csv files
write.csv(iqvia15_1,"~/Desktop/iqvia15_1.csv")
write.csv(iqvia15_2,"~/Desktop/iqvia15_2.csv")
write.csv(iqvia15_3,"~/Desktop/iqvia15_3.csv")
write.csv(iqvia15_4,"~/Desktop/iqvia15_4.csv")
write.csv(iqvia15_5,"~/Desktop/iqvia15_5.csv")

#Delete Data environment to restore data storage

#2016
iqvia16 <- read.delim("~/Desktop/PartD_Prescriber_PUF_NPI_Drug_16.txt")
#Parse 2016
iqvia16_1 <- iqvia16 %>% 
  slice(1:5000000)
iqvia16_2 <- iqvia16 %>% 
  slice(5000001:10000000) 
iqvia16_3 <- iqvia16 %>% 
  slice(10000001:15000000) 
iqvia16_4 <- iqvia16 %>% 
  slice(15000001:20000000)
iqvia16_5 <- iqvia16 %>% 
  slice(20000001:24964300)
#Export .csv files
write.csv(iqvia16_1,"~/Desktop/iqvia16_1.csv")
write.csv(iqvia16_2,"~/Desktop/iqvia16_2.csv")
write.csv(iqvia16_3,"~/Desktop/iqvia16_3.csv")
write.csv(iqvia16_4,"~/Desktop/iqvia16_4.csv")
write.csv(iqvia16_5,"~/Desktop/iqvia16_5.csv")
```

READING IN DATAFRAMES FOR YEARS 2013-2017
```{r}
#READ IN THE DATAFRAMES
iqvia13_1 <- vroom("~/Desktop/iqvia13_1.csv")
iqvia13_2 <- vroom("~/Desktop/iqvia13_2.csv")
iqvia13_3 <- vroom("~/Desktop/iqvia13_3.csv")
iqvia13_4 <- vroom("~/Desktop/iqvia13_4.csv")
iqvia13_5 <- vroom("~/Desktop/iqvia13_5.csv")

iqvia14_1 <- vroom("~/Desktop/iqvia14_1.csv")
iqvia14_2 <- vroom("~/Desktop/iqvia14_2.csv")
iqvia14_3 <- vroom("~/Desktop/iqvia14_3.csv")
iqvia14_4 <- vroom("~/Desktop/iqvia14_4.csv")
iqvia14_5 <- vroom("~/Desktop/iqvia14_5.csv")

iqvia15_1 <- vroom("~/Desktop/iqvia15_1.csv")
iqvia15_2 <- vroom("~/Desktop/iqvia15_2.csv")
iqvia15_3 <- vroom("~/Desktop/iqvia15_3.csv")
iqvia15_4 <- vroom("~/Desktop/iqvia15_4.csv")
iqvia15_5 <- vroom("~/Desktop/iqvia15_5.csv")

iqvia16_1 <- vroom("~/Desktop/iqvia16_1.csv")
iqvia16_2 <- vroom("~/Desktop/iqvia16_2.csv")
iqvia16_3 <- vroom("~/Desktop/iqvia16_3.csv")
iqvia16_4 <- vroom("~/Desktop/iqvia16_4.csv")
iqvia16_5 <- vroom("~/Desktop/iqvia16_5.csv")
#2017
iqvia1 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia1data.csv")
iqvia2 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia2data.csv")
iqvia3 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia3data.csv")
iqvia4 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia4data.csv")
iqvia5 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia5data.csv")

#Filter for antibiotic drugs only:
iqvia13_1 <- filter(iqvia13_1, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_2 <- filter(iqvia13_2, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_3 <- filter(iqvia13_3, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_4 <- filter(iqvia13_4, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_5 <- filter(iqvia13_5, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13 <- rbind(iqvia13_1, iqvia13_2, iqvia13_3, iqvia13_4, iqvia13_5) #combined for 2013

#2014
iqvia14_1 <- filter(iqvia14_1, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_2 <- filter(iqvia14_2, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_3 <- filter(iqvia14_3, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_4 <- filter(iqvia14_4, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_5 <- filter(iqvia14_5, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14 <- rbind(iqvia14_1, iqvia14_2, iqvia14_3, iqvia14_4, iqvia14_5) #combined for 2014

#2015
iqvia15_1 <- filter(iqvia15_1, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_2 <- filter(iqvia15_2, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_3 <- filter(iqvia15_3, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_4 <- filter(iqvia15_4, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_5 <- filter(iqvia15_5, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15 <- rbind(iqvia15_1, iqvia15_2, iqvia15_3, iqvia15_4, iqvia15_5) #combined for 2015

#2016
iqvia16_1 <- filter(iqvia16_1, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_2 <- filter(iqvia16_2, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_3 <- filter(iqvia16_3, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_4 <- filter(iqvia16_4, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_5 <- filter(iqvia16_5, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16 <- rbind(iqvia16_1, iqvia16_2, iqvia16_3, iqvia16_4, iqvia16_5) #combined for 2016

#2017
iqvia1 <- filter(iqvia1, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2017") 
iqvia2 <- filter(iqvia2, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2017") 
iqvia3 <- filter(iqvia3, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2017") 
iqvia4 <- filter(iqvia4, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2017")
iqvia5 <- filter(iqvia5, generic_name %in% PARTD_AntibioticGeneric$`Generic Name`) %>%
  mutate(Year = "2017")
iqvia17 <- rbind(iqvia1, iqvia2, iqvia3, iqvia4, iqvia5) #combined for 2017

```

IMPORTING ENROLLMENT DATA AND MERGING WITH EACH YEAR
(2013):
```{r}
#importing Enrollment data
Enroll_13 <- read.csv("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Data/MedicareEnroll_Data/MedicareEnroll_2013.csv")
#Data wrangling for Enroll_13
Enroll_13 <- Enroll_13 %>%
  mutate(nppes_provider_state = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY",
                           "Puerto Rico" = "PR",
                           "Guam"="GU",
                           "American Samoa"="AS",
                           "Virgin Islands "="VI")) %>%
  select(-Location)
#reorder columns in Enroll_13
Enroll_13 <- Enroll_13[c(3,1,2)]

#Merge Enroll data with iqvia13 data
iqvia13 <- merge(x = iqvia13, y = Enroll_13, by = "nppes_provider_state", all.x = TRUE)

#Erase commas
iqvia13$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia13$Total_MedicareEnroll))
iqvia13$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia13$Total_PartDEnroll))
```

IMPORTING ENROLLMENT DATA AND MERGING WITH EACH YEAR
(2014):
```{r}
#importing Enrollment data
Enroll_14 <- read.csv("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Data/MedicareEnroll_Data/MedicareEnroll_2014.csv")
#Data wrangling for Enroll_14
Enroll_14 <- Enroll_14 %>%
  mutate(nppes_provider_state = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY",
                           "Puerto Rico" = "PR",
                           "Guam"="GU",
                           "American Samoa"="AS",
                           "Virgin Islands "="VI")) %>%
  select(-Location)
#reorder columns in Enroll_14
Enroll_14 <- Enroll_14[c(3,1,2)]

#Merge Enroll data with iqvia14 data
iqvia14 <- merge(x = iqvia14, y = Enroll_14, by = "nppes_provider_state", all.x = TRUE)

#Erase commas
iqvia14$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia14$Total_MedicareEnroll))
iqvia14$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia14$Total_PartDEnroll))

```

IMPORTING ENROLLMENT DATA AND MERGING WITH EACH YEAR
(2015):
```{r}
#importing Enrollment data
Enroll_15 <- read.csv("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Data/MedicareEnroll_Data/MedicareEnroll_2015.csv")
#Data wrangling for Enroll_15
Enroll_15 <- Enroll_15 %>%
  mutate(nppes_provider_state = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY",
                           "Puerto Rico" = "PR",
                           "Guam"="GU",
                           "American Samoa"="AS",
                           "Virgin Islands "="VI")) %>%
  select(-Location)
#reorder columns in Enroll_15
Enroll_15 <- Enroll_15[c(3,1,2)]

#Merge Enroll data with iqvia15 data
iqvia15 <- merge(x = iqvia15, y = Enroll_15, by = "nppes_provider_state", all.x = TRUE)

#Erase commas
iqvia15$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia15$Total_MedicareEnroll))
iqvia15$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia15$Total_PartDEnroll))
```

IMPORTING ENROLLMENT DATA AND MERGING WITH EACH YEAR
(2016):
```{r}
#importing Enrollment data
Enroll_16 <- read.csv("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Data/MedicareEnroll_Data/MedicareEnroll_2016.csv")

#Data wrangling for Enroll_16
Enroll_16 <- Enroll_16 %>%
  mutate(nppes_provider_state = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY",
                           "Puerto Rico" = "PR",
                           "Guam"="GU",
                           "American Samoa"="AS",
                           "Virgin Islands "="VI")) %>%
  select(-Location)
#reorder columns in Enroll_16
Enroll_16 <- Enroll_16[c(3,1,2)]
#Merge Enroll data with iqvia16 data
iqvia16 <- merge(x = iqvia16, y = Enroll_16, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia16$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia16$Total_MedicareEnroll))
iqvia16$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia16$Total_PartDEnroll))

```

IMPORTING ENROLLMENT DATA AND MERGING WITH EACH YEAR
(2017):
```{r}
#importing Enrollment data
Enroll_17 <- read.csv("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Data/MedicareEnroll_Data/MedicareEnroll_2017.csv")

#Data wrangling for Enroll_17
Enroll_17 <- Enroll_17 %>%
  mutate(nppes_provider_state = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY",
                           "Puerto Rico" = "PR",
                           "Guam"="GU",
                           "American Samoa"="AS",
                           "Virgin Islands "="VI")) %>%
  select(nppes_provider_state, Total_PartDEnroll, Total_MedicareEnroll)
#reorder columns in Enroll_17
Enroll_17 <- Enroll_17[c(3,1,2)]
#Merge Enroll data with iqvia17 data
iqvia17 <- merge(x = iqvia17, y = Enroll_17, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia17$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia17$Total_MedicareEnroll))
iqvia17$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia17$Total_PartDEnroll))

```

MERGING ALL DATAFRAMES FOR ALL YEARS (2013-2017)
```{r}
#combine ALL YEARS in one dataset 'combinediqvia'
combinediqvia <- rbind(iqvia13, iqvia14, iqvia15, iqvia16, iqvia17)

#Including Antibiotic classes:
antibioticclasses <- read.csv("distinctantibiotics.csv") %>%
  select(-code, -reference)
colnames(antibioticclasses)[1] <- "generic_name"
combinediqvia <- combinediqvia %>% 
  left_join(antibioticclasses, by = "generic_name")

#insert division column (9 divisions)
combinediqvia <- combinediqvia %>%
  mutate(Division = ifelse(nppes_provider_state %in% c("IL", "IN", "MI", "OH", "WI"), "East North Central",
                         ifelse(nppes_provider_state %in% c("AL", "KY", "MS", "TN"), "East South Central",
                                ifelse(nppes_provider_state %in% c("NJ", "NY", "PA"), "Middle Atlantic",
                                       ifelse(nppes_provider_state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY"), "Mountain",
                                              ifelse(nppes_provider_state %in% c("CT", "ME", "MA", "NH", "RI", "VT"), "New England",
                                                     ifelse(nppes_provider_state %in% c("AK", "CA", "HI", "OR", "WA"), "Pacific",
                                                            ifelse(nppes_provider_state %in% c("DE", "DC", "FL", "GA", "MD", "NC", "SC", "VA", "WV"), "South Atlantic",
                                                                   ifelse(nppes_provider_state %in% c("IA", "KS", "MN", "MO", "NE", "ND", "SD"), "West North Central",
                                                                          ifelse(nppes_provider_state %in% c("AR", "LA", "OK", "TX"), "West South Central", "Undefined Division")))))))))) %>%
  select(-npi, 
         -nppes_provider_last_org_name, 
         -nppes_provider_first_name, 
         -nppes_provider_city,
         -description_flag,
         -bene_count_ge65_suppress_flag,
         -ge65_suppress_flag)

#Adding Region (4 regions)
combinediqvia <- combinediqvia %>%
  mutate(Region = ifelse(nppes_provider_state %in% c("CT", "ME", "MA", "NH", "RI", "VT", "NJ", "NY", "PA"), "Northeast",
                         ifelse(nppes_provider_state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD"), "Midwest",
                                ifelse(nppes_provider_state %in% c("DE", "DC", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", "LA", "OK", "TX"), "South",
                                       ifelse(nppes_provider_state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA"), "West", "Undefined Region")))))

```



PER CAPITA ENROLLMENT CALCULATION:
```{r}
#Grouped by Region and Year --- TOTAL_MEDICAREENROLL
##all ages
#PerCapita_Enroll_ALLAGES <- combinediqvia %>%
#  filter(Region != "Region Undefined") %>%
#  group_by(Region, Year) %>% 
#  summarise(totalprescriptioncount = sum(total_claim_count),
#            total_medicareEnroll = mean(Total_MedicareEnroll),
#            percapita_Enroll = totalprescriptioncount/total_medicareEnroll) %>% 
#  arrange(desc(percapita_Enroll))

#bargraph
#ggplot(PerCapita_Enroll_ALLAGES, aes(x = reorder(Region, -percapita_Enroll), y = percapita_Enroll)) + geom_col() + labs(x = "Region", y = "Total prescription Count per capita enrollment", title = "Total Claims per capita enrollment by Region 2013-2017") + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Year)

##ages 65+
#PerCapita_Enroll_AGES65 <- combinediqvia %>%
#  filter(Region != "Region Undefined") %>%
#  mutate(percent_age65over = bene_count_ge65/bene_count) %>%
#  group_by(Region, Year) %>% 
#  summarise(avg_percent = mean(percent_age65over,na.rm = TRUE),
#            totalprescriptioncount = sum(total_claim_count_ge65, na.rm = TRUE),
#            total_relative_medicareEnroll = avg_percent*mean(Total_MedicareEnroll, na.rm = TRUE),
#            percapita_Enroll = totalprescriptioncount/total_relative_medicareEnroll) %>% 
#  arrange(desc(percapita_Enroll))

#bargraph
#ggplot(PerCapita_Enroll_AGES65, aes(x = reorder(Region, -percapita_Enroll), y = percapita_Enroll)) + geom_col() + labs(x = "Region", y = "Total prescription Count per capita enrollment for 65+ yrs", title = "Total Claims per capita enrollment for 65+ by Region in 2017") + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Year)

#Grouped by Region and Year --- TOTAL_PARTDENROLL
PerCapita_PartD_ALLAGES <- combinediqvia %>%
  group_by(Region, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = mean(Total_PartDEnroll, na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))
PerCapita_PartD_ALLAGES

#bargraph
ggplot(PerCapita_PartD_ALLAGES, aes(x = reorder(Region, -percapita_Enroll), y = percapita_Enroll)) + geom_col() + labs(x = "Region", y = "Total prescription Count per capita PartD enrollement", title = "Total Claims per capita PartD enrollee by Region 2013-2017") + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Year)

##ages 65+
PerCapita_PartD_AGE65 <- combinediqvia %>%
  filter(Region != "Region Undefined") %>%
  mutate(percent_age65over = bene_count_ge65/bene_count) %>%
  group_by(Region, Year) %>% 
  summarise(avg_percent = mean(percent_age65over,na.rm = TRUE),
            totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = avg_percent*mean(Total_PartDEnroll, na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))
PerCapita_PartD_AGE65

#bargraph
ggplot(PerCapita_PartD_AGE65, aes(x = reorder(Region, -percapita_Enroll), y = percapita_Enroll)) + geom_col() + labs(x = "Region", y = "Total prescription Count per capita 65+ yrs old PartD enrollement", title = "Total Claims per capita 65+ yrs old PartD enrollement PartD enrollee by Region 2013-2017") + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Year)
```

For Enrollment -- Medicare or PartD Enroll?
```{r}
#state
PartD_Prop <- combinediqvia %>%
  mutate(PartD_Prop = Total_PartDEnroll/Total_MedicareEnroll) %>%
  group_by(Year, nppes_provider_state) %>%
  summarise(Enroll_Users = mean(PartD_Prop))

#Region
PartD_Prop_Region <- combinediqvia%>%
  filter(Region != "Region Undefined") %>%
  mutate(PartD_Prop = Total_PartDEnroll/Total_MedicareEnroll) %>%
  group_by(Year, Region) %>%
  summarise(Enroll_PartD_Users = mean(PartD_Prop))
```

Total Claim Count by Region
```{r}
#REGION
PartD_ClaimCount <- combinediqvia %>%
  group_by(Region, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE)) %>% 
  arrange(desc(totalprescriptioncount))
PartD_ClaimCount

#bargraph
ggplot(PartD_ClaimCount, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Prescription Claim Count", title = "Total Prescription Claim Counts by Region 2013-2017") + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Year)

#DIVISION
PartD_ClaimCount <- combinediqvia %>%
  group_by(Division, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE)) %>% 
  arrange(desc(totalprescriptioncount))
PartD_ClaimCount

#bargraph
ggplot(PartD_ClaimCount, aes(x = reorder(Division, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Division", y = "Prescription Claim Count", title = "Total Prescription Claim Counts by Division 2013-2017") + theme(axis.text.x = element_text(angle = 90)) + facet_wrap(~Year)
```


MAPPING:
```{r}
library(ggplot2)
library(sf)

usgeom <- 

```

CLASS Missing values:
```{r}
library(forcats)

#mode function
#mode <- function(x) {
#  ux <- unique(x)
#  ux[which.max(tabulate(match(x, ux)))]
#}

test_missingvalues <- combinediqvia %>%
  mutate(class = forcats::fct_explicit_na(class)) %>%
  group_by(class, Region, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

test_graph <- ggplot(test_missingvalues, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "CLaim per PartD Enrollee", title = "Claims per PartD Enrollee by Antibiotic Classes", fill = "Region") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
test_graph
  
```

WHAT ARE THE OTHER STATES?
```{r}
otherdivisions <- combinediqvia %>%
  filter(Division == "Undefined Division")

unique(otherdivisions$nppes_provider_state)

#From Medicare PUF Methodology
#“XX” = “Unknown”
#“AA” = “Armed Forces Central/South America”
#“AE” = “Armed Forces Europe”
#“AP” = “Armed Forces Pacific”
#“AS” = “American Samoa”
#“GU” = “Guam”
#“MP” = “Northern Mariana Islands”
#“PR” = “Puerto Rico”
#“VI” = “Virgin Islands”
#“ZZ” = “Foreign Country”

```


PENICILLIN
```{r}
install.packages("ggthemes") # Install 
library(ggthemes)

#Region
#pen <- combinediqvia %>%
#  filter(class == "penicillins") %>%
#  group_by(Year, Region) %>%
#  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
#            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
#            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)


#pen_line <- ggplot(pen, aes(x = Year, y = percapita_Enroll, group = Region, colour = Region)) + 
#  geom_line() + 
#  labs(x = "Year", y = "Per capita Prescriptions", title = expression(paste('Annual ',italic('per capita'),' Penicillin Prescriptions')), subtitle = "2013 - 2017", col = "Region")

#pen_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
#pen_line+ theme_hc() + theme(legend.position = "right", axis.line = element_line(colour = "grey"))
#pen_line+ theme_economist()+  theme(legend.position = "right")


#Division
pen <- combinediqvia %>%
  filter(class == "penicillins") %>%
  group_by(Year, Division) %>%
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

pen$Division[pen$Division == "Undefined Division"] <- "*Other"


pen_line <- ggplot(pen, aes(x = Year, y = percapita_Enroll, group = Division, colour = Division)) + 
  geom_line(size = 0.9) + 
  labs(x = "\nYear\n\n", 
       y = "Per capita Prescriptions\n", 
       title = 'Annual per capita Penicillin Prescriptions\n', 
       subtitle = "2013 - 2017\n", 
       caption = expression(paste(italic("\n\n*Other: Areas identified as Armed Forces, Foreign Country, Puerto Rico, Island and Unknown"))),
       col = "Division")

#From Medicare PUF Methodology
#“XX” = “Unknown”
#“AA” = “Armed Forces Central/South America”
#“AE” = “Armed Forces Europe”
#“AP” = “Armed Forces Pacific”
#“AS” = “American Samoa”
#“GU” = “Guam”
#“MP” = “Northern Mariana Islands”
#“PR” = “Puerto Rico”
#“VI” = “Virgin Islands”
#“ZZ” = “Foreign Country”

#pen_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
#pen_line+ theme_hc() + theme(legend.position = "right", 
#                             axis.line = element_line(colour = "grey"),
#                             plot.title = element_text(face = "bold"),
#                             plot.subtitle = element_text(size = 11))
#pen_line + theme_economist_white() + theme(legend.position = "right",
#                                    legend.text=element_text(size=13),
#                                    plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
#                                    plot.subtitle = element_text(size = 15, hjust = 0.5),
#                                    legend.title = element_text(face = "bold",size = 15, hjust = 0.5),
#                                    axis.line.y = element_line(colour = "black"),
#                                    plot.margin = margin(0.8, 0.8, 0.8, 0.8, "cm"),
#                                    axis.title.x = element_text(size = 13),
#                                    axis.title.y = element_text(size = 13))
pen_line+ theme_economist() + 
  theme(legend.position = "right",
        legend.text=element_text(size=11),
        plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 15, hjust = 0.5),
        legend.title = element_text(face = "bold",size = 15, hjust = 0.5),
        axis.line.y = element_line(colour = "black"),
        plot.margin = margin(0.8, 0.8, 0.8, 0.8, "cm"),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.caption = element_text(size = 11, hjust = 1),
        plot.caption.position = "plot") +
  scale_color_discrete(breaks = c("East North Central",
                                  "East South Central",
                                  "Middle Atlantic",
                                  "Mountain",
                                  "New England",
                                  "Pacific",
                                  "South Atlantic",
                                  "West North Central",
                                  "West South Central",
                                  "*Other"))
  

#Region/Division
#pen <- combinediqvia %>%
#  filter(class == "penicillins") %>%
#  group_by(Year, Division, Region) %>%
#  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
#            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
#            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)
#
#pd <- position_dodge(0.07)
#
#pen_line <- ggplot(pen, aes(x = Year, y = percapita_Enroll, group = Division, colour = Division)) + 
#  geom_line(position = pd) + 
#  geom_point(position = pd, aes(shape = Region), size = 2, colour = "black") +
#  labs(x = "Year", y = "Per capita Prescriptions", title = "Annual per capita Penicillin Prescriptions", subtitle = "2013 - 2017", col = "Division")

#pen_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
#pen_line+ theme_hc() + theme(legend.position = "right", axis.line = element_line(colour = "grey"))
#pen_line+ theme_economist()+  theme(legend.position = "right")

```

MACROLIDE
```{r}
install.packages("ggthemes") # Install 
library(ggthemes)

#Region
macro <- combinediqvia %>%
  filter(class == "macrolides") %>%
  group_by(Year, Region) %>%
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

macro_line <- ggplot(macro, aes(x = Year, y = percapita_Enroll, group = Region, colour = Region)) + 
  geom_line() + 
  labs(x = "Year", y = "Claim per PartD Enrollee", title = "Claims per PartD Enrollee for 2013-2017", subtitle = "Macrolides", col = "Region")

macro_line
macro_line + theme_classic()
macro_line + theme_light()
macro_line+ theme_hc()+ scale_colour_hc()



#Division
macro <- combinediqvia %>%
  filter(class == "macrolides") %>%
  group_by(Year, Division) %>%
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

macro_line <- ggplot(macro, aes(x = Year, y = percapita_Enroll, group = Division, colour = Division)) + 
  geom_line() + 
  labs(x = "Year", y = "Claim per PartD Enrollee", subtitle = "Macrolides", title =  "Claims per PartD Enrollee for 2013-2017", col = "Division")

macro_line
macro_line + theme_classic()
macro_line + theme_light()

macro_line+ theme_hc()+ scale_colour_hc()

```



PER CAPITA PARTD ENROLLMENT -- REGION AND ANTIBIOTIC CLASS
```{r}
totalclaims <- combinediqvia %>%
  mutate(class = forcats::fct_explicit_na(class)) %>%
  group_by(class, Division, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

#bar graph for all the years
totalclaimgraph <- ggplot(totalclaims, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class", fill = "Region") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
totalclaimgraph

#filtering  for the top six antibiotic classes
totalclaims <- totalclaims %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")

totalclaimgraph <- ggplot(totalclaims, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Top Six Antibiotic Classes", fill = "Region") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
totalclaimgraph

#Bargraphs separated by year for zoom in
#2013
totalclaims_13 <- combinediqvia %>%
  filter(Year == "2013") %>%
  group_by(class, Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

totalclaimgraph <- ggplot(totalclaims_13, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2013", fill = "Region") + 
  theme(axis.text.x = element_text(angle = 90))
totalclaimgraph

#2014
totalclaims_14 <- combinediqvia %>%
  filter(Year == "2014") %>%
  group_by(class, Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

totalclaimgraph <- ggplot(totalclaims_14, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2014", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90))
totalclaimgraph

#2015
totalclaims_15 <- combinediqvia %>%
  filter(Year == "2015") %>%
  group_by(class, Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

totalclaimgraph <- ggplot(totalclaims_15, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2015", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90))
totalclaimgraph

#2016
totalclaims_16 <- combinediqvia %>%
  filter(Year == "2016") %>%
  group_by(class, Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

totalclaimgraph <- ggplot(totalclaims_16, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2016", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90))
totalclaimgraph

#2017
totalclaims_17 <- combinediqvia %>%
  filter(Year == "2017") %>%
  group_by(class, Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll))

totalclaimgraph <- ggplot(totalclaims_17, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2017", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90))
totalclaimgraph



```

TOP SIX ANTIBIOTIC CLASSES LINE GRAPH
```{r}
top6 <- combinediqvia %>%
  mutate(class = forcats::fct_explicit_na(class)) %>%
  group_by(class, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

#top6$Division[top6$Division == "Undefined Division"] <- "*Other"

top6 <- top6 %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")
top6$class <- as.character(top6$class)

top6$class[top6$class == "penicillins"] <- "Penicillin"
top6$class[top6$class == "macrolides"] <- "Macrolide"
top6$class[top6$class == "cephalosporin"] <- "Cephalosporin"
top6$class[top6$class == "fluoroquinolones"] <- "Fluoroquinolone"
top6$class[top6$class == "quinolones"] <- "Quinolone"
top6$class[top6$class == "tetracyclines"] <- "Tetracycline"





top6_line <- ggplot(top6, aes(x = Year, y = percapita_Enroll, group = class, colour = class)) + 
  geom_line(size = 0.9) + 
  labs(x = "\nYear\n\n", 
       y = "Per capita Prescriptions\n", 
       title = 'Annual per capita Antibiotic Prescriptions', 
       subtitle = "2013 - 2017\n",
       col = "Antibiotic Class")

top6_line + theme_economist() +
  theme(legend.position = "right",
        legend.text=element_text(size=11),
        plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 15, hjust = 0.5),
        legend.title = element_text(face = "bold",size = 15, hjust = 0.5),
        axis.line.y = element_line(colour = "black"),
        plot.margin = margin(0.8, 0.8, 0.8, 0.8, "cm"),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.caption = element_text(size = 11, hjust = 1),
        plot.caption.position = "plot") +
  scale_color_discrete(breaks = c("Penicillin",
                                  "Macrolide",
                                  "Cephalosporin",
                                  "Fluoroquinolone",
                                  "Quinolone",
                                  "Tetracycline"))

top6_line + theme_clean() +
  theme(legend.position = "right",
        legend.text=element_text(size=11),
        plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 15, hjust = 0.5),
        legend.title = element_text(face = "bold",size = 15, hjust = 0.5),
        axis.line.y = element_line(colour = "black"),
        axis.line.x = element_line(colour = "black"),
        plot.margin = margin(0.8, 0.8, 0.8, 0.8, "cm"),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.caption = element_text(size = 11, hjust = 1),
        plot.caption.position = "plot") +
  scale_color_discrete(breaks = c("Penicillin",
                                  "Macrolide",
                                  "Cephalosporin",
                                  "Fluoroquinolone",
                                  "Quinolone",
                                  "Tetracycline"))

```


Top Six Antibiotic class total claims per capita PARTD Enrollment for all years
```{r}
#filtering for the top six antibiotic classes
totalclaims <- totalclaims %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")

totalclaimgraph <- ggplot(totalclaims, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year) +
  expand_limits(y=2.5)
totalclaimgraph

#2013
totalclaims_13 <- totalclaims_13 %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")

totalclaimgraph <- ggplot(totalclaims_13, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2013", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  expand_limits(y=2.5)
totalclaimgraph

#2014
totalclaims_14 <- totalclaims_14 %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")
  
totalclaimgraph <- ggplot(totalclaims_14, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2014", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  expand_limits(y=2.5)
totalclaimgraph

#2015
totalclaims_15 <- totalclaims_15 %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")
totalclaimgraph <- ggplot(totalclaims_15, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2015", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  expand_limits(y=2.5)
totalclaimgraph

#2016
totalclaims_16 <- totalclaims_16 %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")
totalclaimgraph <- ggplot(totalclaims_16, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2016", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  expand_limits(y=2.5)
totalclaimgraph

#2017
totalclaims_17 <- totalclaims_17 %>%
  filter(class == "penicillins" | 
           class == "macrolides" | 
           class == "cephalosporin" | 
           class == "fluoroquinolones" |
           class == "quinolones" |
           class == "tetracyclines")

totalclaimgraph <- ggplot(totalclaims_17, aes(x = reorder(class, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Class", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of Each Antibiotic Class in 2017", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  expand_limits(y=2.5)
totalclaimgraph

```


ANTIPSYCHOTIC DRUGS:

ANTIPSYCHOTIC DRUGS (COMPARISON GROUP):
```{r}
#READ IN THE DATAFRAMES
iqvia13_1 <- vroom("~/Desktop/iqvia13_1.csv")
iqvia13_2 <- vroom("~/Desktop/iqvia13_2.csv")
iqvia13_3 <- vroom("~/Desktop/iqvia13_3.csv")
iqvia13_4 <- vroom("~/Desktop/iqvia13_4.csv")
iqvia13_5 <- vroom("~/Desktop/iqvia13_5.csv")

iqvia14_1 <- vroom("~/Desktop/iqvia14_1.csv")
iqvia14_2 <- vroom("~/Desktop/iqvia14_2.csv")
iqvia14_3 <- vroom("~/Desktop/iqvia14_3.csv")
iqvia14_4 <- vroom("~/Desktop/iqvia14_4.csv")
iqvia14_5 <- vroom("~/Desktop/iqvia14_5.csv")

iqvia15_1 <- vroom("~/Desktop/iqvia15_1.csv")
iqvia15_2 <- vroom("~/Desktop/iqvia15_2.csv")
iqvia15_3 <- vroom("~/Desktop/iqvia15_3.csv")
iqvia15_4 <- vroom("~/Desktop/iqvia15_4.csv")
iqvia15_5 <- vroom("~/Desktop/iqvia15_5.csv")

iqvia16_1 <- vroom("~/Desktop/iqvia16_1.csv")
iqvia16_2 <- vroom("~/Desktop/iqvia16_2.csv")
iqvia16_3 <- vroom("~/Desktop/iqvia16_3.csv")
iqvia16_4 <- vroom("~/Desktop/iqvia16_4.csv")
iqvia16_5 <- vroom("~/Desktop/iqvia16_5.csv")
#2017
iqvia1 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia1data.csv")
iqvia2 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia2data.csv")
iqvia3 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia3data.csv")
iqvia4 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia4data.csv")
iqvia5 <- vroom("~/Documents/School/Smith Sem 8 LAST SEM/Special Studies/Iqvia Data/iqvia5data.csv")

#Filter for antibiotic drugs only:
iqvia13_1 <- filter(iqvia13_1, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_2 <- filter(iqvia13_2, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_3 <- filter(iqvia13_3, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_4 <- filter(iqvia13_4, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13_5 <- filter(iqvia13_5, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2013") %>%
  select(-'...1')
iqvia13 <- rbind(iqvia13_1, iqvia13_2, iqvia13_3, iqvia13_4, iqvia13_5) #combined for 2013

#2014
iqvia14_1 <- filter(iqvia14_1, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_2 <- filter(iqvia14_2, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_3 <- filter(iqvia14_3, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_4 <- filter(iqvia14_4, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14_5 <- filter(iqvia14_5, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2014") %>%
  select(-'...1')
iqvia14 <- rbind(iqvia14_1, iqvia14_2, iqvia14_3, iqvia14_4, iqvia14_5) #combined for 2014

#2015
iqvia15_1 <- filter(iqvia15_1, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_2 <- filter(iqvia15_2, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_3 <- filter(iqvia15_3, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_4 <- filter(iqvia15_4, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15_5 <- filter(iqvia15_5, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2015") %>%
  select(-'...1')
iqvia15 <- rbind(iqvia15_1, iqvia15_2, iqvia15_3, iqvia15_4, iqvia15_5) #combined for 2015

#2016
iqvia16_1 <- filter(iqvia16_1, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_2 <- filter(iqvia16_2, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_3 <- filter(iqvia16_3, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_4 <- filter(iqvia16_4, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16_5 <- filter(iqvia16_5, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2016") %>%
  select(-'...1')
iqvia16 <- rbind(iqvia16_1, iqvia16_2, iqvia16_3, iqvia16_4, iqvia16_5) #combined for 2016

#2017
iqvia1 <- filter(iqvia1, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2017") 
iqvia2 <- filter(iqvia2, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2017") 
iqvia3 <- filter(iqvia3, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2017") 
iqvia4 <- filter(iqvia4, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2017")
iqvia5 <- filter(iqvia5, generic_name %in% PARTD_AP$`Generic_Name_AP`) %>%
  mutate(Year = "2017")
iqvia17 <- rbind(iqvia1, iqvia2, iqvia3, iqvia4, iqvia5)
```


Add Enroll data for Antipsychotic
```{r}
#Merge Enroll data with iqvia13 data
iqvia13 <- merge(x = iqvia13, y = Enroll_13, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia13$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia13$Total_MedicareEnroll))
iqvia13$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia13$Total_PartDEnroll))

#Merge Enroll data with iqvia14 data
iqvia14 <- merge(x = iqvia14, y = Enroll_14, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia14$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia14$Total_MedicareEnroll))
iqvia14$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia14$Total_PartDEnroll))

#Merge Enroll data with iqvia15 data
iqvia15 <- merge(x = iqvia15, y = Enroll_15, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia15$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia15$Total_MedicareEnroll))
iqvia15$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia15$Total_PartDEnroll))

#Merge Enroll data with iqvia16 data
iqvia16 <- merge(x = iqvia16, y = Enroll_16, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia16$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia16$Total_MedicareEnroll))
iqvia16$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia16$Total_PartDEnroll))

#Merge Enroll data with iqvia157data
iqvia17 <- merge(x = iqvia17, y = Enroll_17, by = "nppes_provider_state", all.x = TRUE)
#Erase commas
iqvia17$Total_MedicareEnroll <- as.numeric(gsub(",","",iqvia17$Total_MedicareEnroll))
iqvia17$Total_PartDEnroll <- as.numeric(gsub(",","",iqvia17$Total_PartDEnroll))

```

Merging all years (2013-2017)
```{r}
#combine ALL YEARS in one dataset 'combinediqvia'
AP_combinediqvia <- rbind(iqvia13, iqvia14, iqvia15, iqvia16, iqvia17)
```

```{r}
#classification
AP_combinediqvia <- AP_combinediqvia %>%
  mutate(Category = ifelse(generic_name %in% c("ARIPIPRAZOLE", "ARIPIPRAZOLE LAUROXIL", "CLOZAPINE", "ILOPERIDONE", "ZIPRASIDONE HCL", "ZIPRASIDONE MESYLATE", "PALIPERIDONE", "PALIPERIDONE PALMITATE", "LURASIDONE HCL", "PIMAVANSERIN TARTRATE", "OLANZAPINE", "QUETIAPINE FUMARATE", "BREXPIPRAZOLE", "QUETIAPINE FUMARATE", "RISPERIDONE", "RISPERIDONE MICROSPHERES", "ASENAPINE MALEATE", "CARIPRAZINE HCL", "OLANZAPINE PAMOATE"), "Second Generation", 
         ifelse(generic_name %in% c("CHLORPROMAZINE HCL", "FLUPHENAZINE DECANOATE", "FLUPHENAZINE HCL", "HALOPERIDOL LACTATE", "HALOPERIDOL LACTATE", "HALOPERIDOL DECANOATE", "HALOPERIDOL", "LOXAPINE SUCCINATE", "MOLINDONE HCL", "PIMOZIDE", "PERPHENAZINE", "THIORIDAZINE HCL", "THIOTHIXENE", "TRIFLUOPERAZINE HCL"), "First Generation", "Mixed Drugs")))

AP_combinediqvia <- AP_combinediqvia %>%
  mutate(Category2 = ifelse(generic_name %in% c("ARIPIPRAZOLE", "ARIPIPRAZOLE LAUROXIL"), "ARIPIPRAZOLE", ifelse(generic_name == "ASENAPINE MALEATE", "ASENAPINE",
  ifelse(generic_name == "BREXPIPRAZOLE", "BREXPIPRAZOLE",
  ifelse(generic_name == "CARIPRAZINE HCL", "CARIPRAZINE",
  ifelse(generic_name == "CHLORPROMAZINE HCL", "CHLORPROMAZINE",
  ifelse(generic_name == "CLOZAPINE", "CLOZAPINE",
  ifelse(generic_name %in% c("FLUPHENAZINE DECANOATE", "FLUPHENAZINE HCL"), "FLUPHENAZINE",
  ifelse(generic_name %in% c("HALOPERIDOL", "HALOPERIDOL DECANOATE", "HALOPERIDOL LACTATE"), "HALOPERIDOL",
  ifelse(generic_name == "ILOPERIDONE", "ILOPERIDONE",
  ifelse(generic_name == "LOXAPINE SUCCINATE", "LOXAPINE",
  ifelse(generic_name == "LURASIDONE HCL", "LURASIDONE",
  ifelse(generic_name == "MOLINDONE HCL", "MOLINDONE",
  ifelse(generic_name %in% c("OLANZAPINE", "OLANZAPINE PAMOATE"), "OLANZAPINE", 
  ifelse(generic_name %in% c("PALIPERIDONE", "PALIPERIDONE PALMITATE"), "PALIPERIDONE",
  ifelse(generic_name == "PERPHENAZINE", "PERPHENAZINE",
  ifelse(generic_name == "PIMAVANSERIN TARTRATE", "PIMAVANSERIN",
  ifelse(generic_name == "PIMOZIDE", "PIMOZIDE",
  ifelse(generic_name == "QUETIAPINE FUMARATE", "QUETIAPINE",
  ifelse(generic_name %in% c("RISPERIDONE", "RISPERIDONE MICROSPHERES"), "RISPERIDONE",
  ifelse(generic_name == "THIORIDAZINE HCL", "THIORIDAZINE",
  ifelse(generic_name == "THIOTHIXENE", "THIOTHIXENE", 
  ifelse(generic_name == "TRIFLUOPERAZINE HCL", "TRIFLUOPERAZINE",
  ifelse(generic_name %in% c("ZIPRASIDONE HCL", "ZIPRASIDONE MESYLATE"), "ZIPRASIDONE", "MIXED DRUGS"))))))))))))))))))))))))

#insert region column
AP_combinediqvia <- AP_combinediqvia %>%
  mutate(Division = ifelse(nppes_provider_state %in% c("IL", "IN", "MI", "OH", "WI"), "East North Central",
                         ifelse(nppes_provider_state %in% c("AL", "KY", "MS", "TN"), "East South Central",
                                ifelse(nppes_provider_state %in% c("NJ", "NY", "PA"), "Middle Atlantic",
                                       ifelse(nppes_provider_state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY"), "Mountain",
                                              ifelse(nppes_provider_state %in% c("CT", "ME", "MA", "NH", "RI", "VT"), "New England",
                                                     ifelse(nppes_provider_state %in% c("AK", "CA", "HI", "OR", "WA"), "Pacific",
                                                            ifelse(nppes_provider_state %in% c("DE", "DC", "FL", "GA", "MD", "NC", "SC", "VA", "WV"), "South Atlantic",
                                                                   ifelse(nppes_provider_state %in% c("IA", "KS", "MN", "MO", "NE", "ND", "SD"), "West North Central",
                                                                          ifelse(nppes_provider_state %in% c("AR", "LA", "OK", "TX"), "West South Central", "Undefined")))))))))) %>%
  select(-npi, 
         -nppes_provider_last_org_name, 
         -nppes_provider_first_name, 
         -nppes_provider_city,
         -description_flag,
         -bene_count_ge65_suppress_flag,
         -ge65_suppress_flag)

AP_combinediqvia <- AP_combinediqvia %>%
  mutate(Region = ifelse(nppes_provider_state %in% c("CT", "ME", "MA", "NH", "RI", "VT", "NJ", "NY", "PA"), "Northeast",
                         ifelse(nppes_provider_state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD"), "Midwest",
                                ifelse(nppes_provider_state %in% c("DE", "DC", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", "LA", "OK", "TX"), "South",
                                       ifelse(nppes_provider_state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA"), "West", "Undefined Region")))))

```

Antipsychotic drugs EDA
```{r}
#CATEGORY1
test_AP <- AP_combinediqvia %>%
  group_by(Category, Region, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count, na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>% 
  arrange(desc(percapita_Enroll)) 

test_graph <- ggplot(test_AP, aes(x = reorder(Category, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Antipsychotic Drug Category", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of AP Category", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
test_graph

#CATEGORY2
test_AP <- AP_combinediqvia  %>%
  group_by(Category2, Region, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count, na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>%
  arrange(desc(percapita_Enroll))

test_graph <- ggplot(test_AP, aes(x = reorder(Category2, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Antipsychotic Drug Category", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of AP Category", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
test_graph

# TOP SIX DRUGS
test_AP <- test_AP %>%
  filter(Category2 == "QUETIAPINE"|
           Category2 == "RISPERIDONE" |
           Category2 == "OLANZAPINE"|
           Category2 == "ARIPIPRAZOLE"|
           Category2 == "HALOPERIDOL"|
           Category2 == "CLOZAPINE")

test_graph <- ggplot(test_AP, aes(x = reorder(Category2, -percapita_Enroll), y = percapita_Enroll, fill = Region)) +
  geom_col() + 
  labs(x = "Antipsychotic Drug Category", y = "Total Claim Count", title = "Total Claims per capita PartD Enrollment of AP Category", fill = "Division") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
test_graph
```

QUETIAPINE
```{r}
#Region
quet <- AP_combinediqvia %>%
  filter(Category2 == "QUETIAPINE") %>%
  group_by(Year, Region) %>%
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

quet_line <- ggplot(quet, aes(x = Year, y = percapita_Enroll, group=Region, colour = Region)) + geom_line() + labs(x = "Year", y = "Per capita Prescriptions", title = "Annual italic(per capita) Quetiapine Prescriptions", subtitle = "2013 - 2017", col = "Region")

quet_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
quet_line+ theme_hc() + theme(legend.position = "right", axis.line = element_line(colour = "grey"))
quet_line+ theme_economist()+  theme(legend.position = "right")




#Division
quet <- AP_combinediqvia %>%
  filter(Category2 == "QUETIAPINE") %>%
  group_by(Year, Division) %>%
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

quet$Division[quet$Division == "Undefined"] <- "*Other"

quet_line <- ggplot(quet, aes(x = Year, y = percapita_Enroll, group = Division, colour = Division)) + 
  geom_line(size = 0.9) + 
  labs(x = "\nYear\n\n", 
       y = "Per capita Prescriptions\n", 
       title = 'Annual per capita Quetiapine Prescriptions\n', 
       subtitle = "2013 - 2017\n", 
       caption = expression(paste(italic("\n\n*Other: Areas identified as Armed Forces, Foreign Country, Puerto Rico, Island and Unknown"))),
       col = "Division")

#quet_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
#quet_line+ theme_hc() + theme(legend.position = "right", axis.line = element_line(colour = "grey"))
quet_line + theme_economist() + 
  theme(legend.position = "right",
        legend.text=element_text(size=11),
        plot.title = element_text(size = 17, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 15, hjust = 0.5),
        legend.title = element_text(face = "bold",size = 15, hjust = 0.5),
        axis.line.y = element_line(colour = "black"),
        plot.margin = margin(0.8, 0.8, 0.8, 0.8, "cm"),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.caption = element_text(size = 11, hjust = 1),
        plot.caption.position = "plot") +
  scale_color_discrete(breaks = c("East North Central",
                                  "East South Central",
                                  "Middle Atlantic",
                                  "Mountain",
                                  "New England",
                                  "Pacific",
                                  "South Atlantic",
                                  "West North Central",
                                  "West South Central",
                                  "*Other"))
#Region/Division
quet <- AP_combinediqvia %>%
  filter(Category2 == "QUETIAPINE") %>%
  group_by(Year, Division, Region) %>%
  summarise(totalprescriptioncount = sum(total_claim_count,na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

pd <- position_dodge(0.07)

quet_line <- ggplot(quet, aes(x = Year, y = percapita_Enroll, group = Division, colour = Division)) + 
  geom_line(position = pd) + 
  geom_point(position = pd, aes(shape = Region), size = 2, colour = "black") +
  labs(x = "Year", y = "Per capita Prescriptions", title = "Annual Per capita Quetiapine Prescriptions", subtitle = "2013 - 2017", col = "Division")

quet_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
quet_line+ theme_hc() + theme(legend.position = "right", axis.line = element_line(colour = "grey"))
quet_line+ theme_economist()+  theme(legend.position = "right")

```

```{r}
#Undefined Region
#Mainly Puerto Rico?

Undefined <- AP_combinediqvia %>%
  filter(Region == "Undefined Region") %>%
  group_by(nppes_provider_state) %>%
  summarise(Count = n())
Undefined

#graphing the use of AP in PR
PR_AP <- AP_combinediqvia  %>%
  filter(nppes_provider_state == "PR") %>%
  group_by(Category2, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count, na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll) %>%
  arrange(desc(percapita_Enroll))

PR_graph <- ggplot(PR_AP, aes(x = reorder(Category2, -percapita_Enroll), y = percapita_Enroll)) +
  geom_col() + 
  labs(x = "Antipsychotic Drug Category", y = "Total Claim Count", title = "Claims per PartD Enrollee in PR") + 
  theme(axis.text.x = element_text(angle = 90)) +
  facet_wrap(~Year)
PR_graph

#TOP FIVE AP in PR
PR_AP <- AP_combinediqvia %>%
  filter(Category2 == "QUETIAPINE"|
           Category2 == "RISPERIDONE" |
           Category2 == "OLANZAPINE"|
           Category2 == "ARIPIPRAZOLE"|
           Category2 == "HALOPERIDOL") %>%
  filter(nppes_provider_state == "PR") %>%
  group_by(Category2, Year) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count, na.rm = TRUE),
            total_PartDEnroll = sum(unique(Total_PartDEnroll), na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_PartDEnroll)

PR_line <- ggplot(PR_AP, aes(x = Year, y = percapita_Enroll, group = Category2, colour = Category2)) + 
  geom_line() + 
  labs(x = "Year", y = "Claim per PartD Enrollee", title = "Claims per PartD Enrollee in PR", subtitle = "2013 - 2017", col = "Category")

PR_line + theme_minimal() + theme(axis.line = element_line(colour = "grey"))
PR_line+ theme_hc() + theme(legend.position = "right", axis.line = element_line(colour = "grey"))
PR_line+ theme_economist()+  theme(legend.position = "right")



```

```{r}
#AP Distribution of Counts for the Regions 
Count_AP <- AP_combinediqvia %>%
  filter(Year == "2017") %>%
  group_by(Region) %>%
  summarise(Count = n())

```


Chi Square tests
```{r}
#Penicillin
penicillins_avgpercapita <- totalclaims %>%
  filter(class == "penicillins") %>%
  group_by(Year) %>%
  summarise(avg_percapita = mean(percapita_Enroll))
penicillins <-totalclaims %>%
  filter(class == "penicillins")
penicillins <- left_join(penicillins, penicillins_avgpercapita, by = "Year")
penicillins <- penicillins %>%
  mutate(expected_totalprescriptioncount = avg_percapita*total_PartDEnroll)

chisq.test(penicillins$totalprescriptioncount, penicillins$expected_totalprescriptioncount, correct = F)

#Macrolide
macrolides_avgpercapita <- totalclaims %>%
  filter(class == "macrolides") %>%
  group_by(Year) %>%
  summarise(avg_percapita = mean(percapita_Enroll))
macrolides <-totalclaims %>%
  filter(class == "macrolides")
macrolides <- left_join(macrolides, macrolides_avgpercapita, by = "Year")
macrolides <- macrolides %>%
  mutate(expected_totalprescriptioncount = avg_percapita*total_PartDEnroll)

#Cephalosporin
cephalosporin_avgpercapita <- totalclaims %>%
  filter(class == "cephalosporin") %>%
  group_by(Year) %>%
  summarise(avg_percapita = mean(percapita_Enroll))
cephalosporin <-totalclaims %>%
  filter(class == "cephalosporin")
cephalosporin <- left_join(cephalosporin, macrolides_avgpercapita, by = "Year")
cephalosporin <- cephalosporin %>%
  mutate(expected_totalprescriptioncount = avg_percapita*total_PartDEnroll)

#fluoroquinolones
fluoroquinolones_avgpercapita <- totalclaims %>%
  filter(class == "fluoroquinolones") %>%
  group_by(Year) %>%
  summarise(avg_percapita = mean(percapita_Enroll))
fluoroquinolones <-totalclaims %>%
  filter(class == "fluoroquinolones")
fluoroquinolones <- left_join(fluoroquinolones, fluoroquinolones_avgpercapita, by = "Year")
fluoroquinolones <- fluoroquinolones %>%
  mutate(expected_totalprescriptioncount = avg_percapita*total_PartDEnroll)

#quinolones
quinolones_avgpercapita <- totalclaims %>%
  filter(class == "quinolones") %>%
  group_by(Year) %>%
  summarise(avg_percapita = mean(percapita_Enroll))
quinolones <-totalclaims %>%
  filter(class == "quinolones")
quinolones <- left_join(quinolones, quinolones_avgpercapita, by = "Year")
quinolones <- quinolones %>%
  mutate(expected_totalprescriptioncount = avg_percapita*total_PartDEnroll)

#tetracyclines
tetracyclines_avgpercapita <- totalclaims %>%
  filter(class == "tetracyclines") %>%
  group_by(Year) %>%
  summarise(avg_percapita = mean(percapita_Enroll))
tetracyclines <-totalclaims %>%
  filter(class == "tetracyclines")
tetracyclines <- left_join(tetracyclines, tetracyclines_avgpercapita, by = "Year")
tetracyclines <- tetracyclines %>%
  mutate(expected_totalprescriptioncount = avg_percapita*total_PartDEnroll)

```


Normalize to pop/age distribution:
```{r}
#Based on the enrollment data: only 15% of total medical enrollees in 2017 were under the age of 65, meaning majority are over the age of 65 - knowing this, will make a variable for aggregate population for each state under 65

#importing population data for 2017
pop_2017 <- read.csv("~/Documents/GitHub/DoritLab-AntibioticTrends/Data/2017_populationct.csv") %>%
  select(-Year) %>%
  filter(Location != "United States") %>%
  mutate(nppes_provider_state = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY",
                           "Puerto Rico" = "PR",
                           "Guam"="GU",
                           "American Samoa"="AS",
                           "Virgin Islands"="VI")) %>%
  mutate(AgeUnder65_17 = Total - X65.) %>%
  rename('Total_population_17'='Total',
         'Age65+_17'='X65.',
         'Age0-18_17'='Children.0.18',
         'Age19-25_17'='Adults.19.25',
         'Age26-34_17'='Adults.26.34',
         'Age35-54_17'='Adults.35.54',
         'Age55-64_17'='Adults.55.64') %>%
  select(-Location)

#reorder columns in pop_2017
pop_2017 <- pop_2017[c(8,7,6,9,1,2,3,4,5)]


##turn NAS to 0
#combinediqvia_17$Total_population_17[is.na(combinediqvia_17$Total_population_17)] <- 0
#combinediqvia_17$Total_MedicareEnroll[is.na(combinediqvia_17$Total_MedicareEnroll)] <- 0
#combinediqvia_17$Total_PartDEnroll[is.na(combinediqvia_17$Total_PartDEnroll)] <- 0
#combinediqvia_17$StandAlone_DrugPlanEnroll[is.na(combinediqvia_17$StandAlone_DrugPlanEnroll)] <- 0
#combinediqvia_17$MedicareAdv_DrugPlanEnroll[is.na(combinediqvia_17$MedicareAdv_DrugPlanEnroll)] <- 0


##calculate the percent
#combinediqvia_17 <- combinediqvia_17 %>%
#  mutate(Enroll_percapita_17 = bene_count/Total_MedicareEnroll)
#         prop_planDEnroll_17 = Total_PartDEnroll/Total_population_17,
#         prop_AgeOver65 = `Age65+_17`/Total_population_17)

##Selecting wanted variables only:
combinediqvia_17 <- combinediqvia_17 %>%
  select(-nppes_provider_city, -description_flag, -drug_name, -bene_count_ge65_suppress_flag)

```

Per capita enrollment:
```{r}
# USING TOTAL_CLAIMS
region <- combinediqvia %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count),
            total_medicareEnroll = mean(Total_MedicareEnroll),
            percapita_Enroll = totalprescriptioncount/total_medicareEnroll) %>% 
  arrange(desc(percapita_Enroll))
region

ggplot(region, aes(x = reorder(Region, -percapita_Enroll), y = percapita_Enroll)) + geom_col() + labs(x = "Region", y = "Total prescription Count per capita enrollment", title = "Total Claims per capita enrollment by Region 2013-2017") + theme(axis.text.x = element_text(angle = 90))

#Checking the age distribution of states
Age_over65_state <- combinediqvia_17 %>%
  mutate(percent_over65 = (`Age65+_17`/Total_population_17)*100) %>%
  group_by(nppes_provider_state) %>%
  summarise(percent_over65 = mean(percent_over65, na.rm = TRUE))

Age_over65_region <- combinediqvia_17 %>%
  mutate(percent_over65 = (`Age65+_17`/Total_population_17)*100) %>%
  group_by(Region) %>%
  summarise(percent_over65 = mean(percent_over65, na.rm = TRUE))

#boxplot of percent age 65 years older
boxplot_over65 <- combinediqvia_17 %>%
  mutate(prop_age65over_Enrolls = bene_count_ge65/bene_count,
         prop_age65over = `Age65+_17`/Total_population_17) %>%
  select(nppes_provider_state, Region, prop_age65over_Enrolls, prop_age65over)

boxplot_over65 <- na.omit(boxplot_over65) 

ggplot(boxplot_over65, aes(x=Region, y=prop_age65over_Enrolls)) + 
  geom_boxplot(outlier.colour=NA) + coord_cartesian(ylim = c(0, 1.0))

ggplot(boxplot_over65, aes(x=Region, y=prop_age65over)) + 
  geom_boxplot(outlier.colour=NA) + coord_cartesian(ylim = c(0, 1.0))

boxplot_over65 <- boxplot_over65 %>%
  group_by(Region) %>%
  summarise(avgProp_age65over = mean(prop_age65over_Enrolls))

# USING TOTAL_CLAIMS_GE65 - beneficiaries older than 65 years old 
#combinediqvia_17$total_claim_count_ge65[is.na(combinediqvia_17$total_claim_count_ge65)] <- 0
#combinediqvia_17$bene_count_ge65[is.na(combinediqvia_17$bene_count_ge65)] <- 0
#combinediqvia_17$bene_count[is.na(combinediqvia_17$bene_count)] <- 0


region <- combinediqvia_17 %>%
  mutate(percent_age65over = bene_count_ge65/bene_count) %>%
  group_by(Region) %>% 
  summarise(avg_percent = mean(percent_age65over,na.rm = TRUE),
            totalprescriptioncount = sum(total_claim_count_ge65, na.rm = TRUE),
            total_relative_medicareEnroll = avg_percent*mean(Total_MedicareEnroll, na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_relative_medicareEnroll) %>% 
  arrange(desc(percapita_Enroll))

ggplot(region, aes(x = reorder(Region, -percapita_Enroll), y = percapita_Enroll)) + geom_col() + labs(x = "Region", y = "Total prescription Count per capita enrollment for 65+ yrs", title = "Total Claims per capita enrollment for 65+ by Region in 2017") + theme(axis.text.x = element_text(angle = 90))
region

##Compare to original WITHOUT per capita:
region <- combinediqvia %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>%
  filter(Region != "Region Undefined")

ggplot(region, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))

```

#Looking at Prescribers
```{r}
#EastSouthCentral
EastSouthCentral <- combinediqvia_17 %>%
  mutate(percent_age65over = bene_count_ge65/bene_count) %>%
  filter(Region == "East South Central") %>%
  group_by(specialty_description) %>%
  summarise(avg_percent = mean(percent_age65over,na.rm = TRUE),
            totalprescriptioncount = sum(total_claim_count_ge65, na.rm = TRUE),
            total_relative_medicareEnroll = avg_percent*mean(Total_MedicareEnroll, na.rm = TRUE),
            percapita_Enroll = totalprescriptioncount/total_relative_medicareEnroll) %>% 
  arrange(desc(percapita_Enroll))


  
```



EDA for IQVIA data:

NAs
```{r}
glimpse(combinediqvia)
summary(combinediqvia)

#about NAs
combinediqvia %>% map(~ mean(is.na(.)))

#filter for only NAs in bene_count

```

description_flag
```{r}
descrip_flag <- combinediqvia %>%
  group_by(description_flag) %>%
  summarise(count = n(),
            percent = 100*(count/1519798))

ggplot(descrip_flag, aes(description_flag, percent)) + geom_col() + coord_flip()
# majority of the specialty description is associated to Medicare specialty code/Part B, if more htan one specialty - code asociated with the largest number of services reported

```


bene_count
```{r}
#histogram displaying the distribution of beneficiaries number
distrib_bene <- ggplot(combinediqvia, aes(bene_count)) + geom_histogram(na.rm = TRUE) + scale_y_log10() + facet_wrap(~Region)
distrib_bene

#least number of beneficiaries (bene_count <= 11)
combinediqvia_leastbene <- combinediqvia %>%
  filter(bene_count <= 11) #add n/a rows next time --> insert randomized counts from 0-11?

totaliqvia2017_leastbene <- combinediqvia_leastbene %>% 
  group_by(generic_name) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(25)

ggplot(totaliqvia2017_leastbene, aes(x = reorder(generic_name, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Generic Antibiotic Name", y = "Total Prescription Claims", title = "Top Prescribed Antibiotics with the LEAST number of Medicare Beneficiaries") + theme(axis.text.x = element_text(angle = 90))

#Most number of beneficiaries (bene)
combinediqvia_mostbene <- combinediqvia %>%
  filter(bene_count > 500) #add n/a rows next time --> insert randomized counts from 0-11?

totaliqvia2017_mostbene <- combinediqvia_mostbene %>% 
  group_by(generic_name) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(25)

ggplot(totaliqvia2017_mostbene, aes(x = reorder(generic_name, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Generic Antibiotic Name", y = "Total Prescription Claims", title = "Top Prescribed Antibiotics with the MOST number of Medicare Beneficiaries") + theme(axis.text.x = element_text(angle = 90))

#In general for year 2017
totaliqvia2017 <- combinediqvia %>% 
  group_by(generic_name) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(25)

ggplot(totaliqvia2017, aes(x = reorder(generic_name, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Generic Antibiotic Name", y = "Total Prescription Claims", title = "Count of Top 25 Highest Prescribed Antibiotics in 2017") + theme(axis.text.x = element_text(angle = 90))

#In general for year 2017 (ge65)
totaliqvia2017 <- combinediqvia %>% 
  group_by(generic_name) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count_ge65)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(10)

ggplot(totaliqvia2017, aes(x = reorder(generic_name, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Generic Antibiotic Name", y = "Total Prescription Claims", title = "Count of Top 10 Highest Prescribed Antibiotics for 65+ in 2017") + theme(axis.text.x = element_text(angle = 90))


```

specialty_description:
```{r}
#distribution of specialty
totaliqvia2017 <- combinediqvia %>% 
  group_by(specialty_description) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(10)

ggplot(totaliqvia2017, aes(x = reorder(specialty_description, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Prescriber Specialty", y = "Total Prescription Claims", title = "Count of Top 10 Highest Prescribers in 2017") + theme(axis.text.x = element_text(angle = 90))

#distribution of specialty
totaliqvia2017 <- combinediqvia %>% 
  group_by(specialty_description) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange() %>% 
  head(10)

ggplot(totaliqvia2017, aes(x = reorder(specialty_description, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Prescriber Specialty", y = "Total Prescription Claims", title = "Count of Bottom 10 Prescribers in 2017") + theme(axis.text.x = element_text(angle = 90))

#distribution of specialty for only 65+
total_spec_ge65 <- combinediqvia %>% 
  group_by(specialty_description) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count_ge65)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(10)

ggplot(total_spec_ge65, aes(x = reorder(specialty_description, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Prescriber Specialty", y = "Total Prescription Claims", title = "Count of Top 10 Highest Prescribers for 65+ in 2017") + theme(axis.text.x = element_text(angle = 90)) #There are a lot more NA values for total_claim_count_ge65

# general specialty distribution by region
## Family Medicine
region_familymedicine <- combinediqvia %>% 
  filter(specialty_description == "Family Practice") %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_familymedicine, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Family Practice Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))

## Internal Medicine
region_internalmed <- combinediqvia %>% 
  filter(specialty_description == "Internal Medicine") %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_internalmed, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Internal Medicine Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))

## Nurse Practitioner
region_nursepract <- combinediqvia %>% 
  filter(specialty_description == "Nurse Practitioner") %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_nursepract, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Nurse Practitioner Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))

## Dentist
region_dentist <- combinediqvia %>% 
  filter(specialty_description == "Dentist") %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_dentist, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Dentist Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))

## Physician Assistant
region_pa <- combinediqvia %>% 
  filter(specialty_description == "Physician Assistant") %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_pa, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Physician Assistant Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))

#South Atlantic has most claims for the top five specialties -- followed by East North Central and Middle Atlantic, Pacific and West South Central

region <- combinediqvia %>%
  group_by(Region) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region, aes(x = reorder(Region, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Region", y = "Total Prescription Claims", title = "Count of Claims by Region in 2017") + theme(axis.text.x = element_text(angle = 90))



```

total_day_supply
```{r}
remove.packages("ggplot2") # Unisntall ggplot
install.packages("ggplot2") # Install it again
library(ggplot2)

# looking at total supply with top five prescribers
total_supply_top5 <- combinediqvia %>% 
  filter(specialty_description == "Family Practice" |
           specialty_description == "Internal Medicine" |
           specialty_description == "Nurse Practitioner" |
           specialty_description == "Dentist" |
           specialty_description == "Physician Assistant")

gglot(total_supply_top5, aes(specialty_description, total_day_supply)) + geom_boxplot()

# looking at total supply with bottom five prescribers
total_supply_bottom5 <- combinediqvia %>% 
  filter(specialty_description == "Cardiology" |
           specialty_description == "Allergy/ Immunology" |
           specialty_description == "Anesthesiology" |
           specialty_description == "Cardiac Surgery" |
           specialty_description == "Addiction Medicine")

gglot(total_supply_bottom5, aes(specialty_description, total_day_supply)) + geom_boxplot()


```


Region
```{r}
#South Atlantic:
region_southatlantic <- combinediqvia %>%
  filter(Region == "South Atlantic")
##total claims by state
region_southatlantic_state <- region_southatlantic %>%
  group_by(nppes_provider_state) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_southatlantic_state, aes(x = reorder(nppes_provider_state, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "State", y = "Total Prescription Claims", title = "Count of Toal Claims by State for South Atlantic Region in 2017") + theme(axis.text.x = element_text(angle = 90))

#East North Central:
region_eastnorthcentral <- combinediqvia %>%
  filter(Region == "East North Central")
##total claims by state
region_eastnorthcentral_state <- region_eastnorthcentral %>%
  group_by(nppes_provider_state) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount))

ggplot(region_eastnorthcentral_state, aes(x = reorder(nppes_provider_state, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "State", y = "Total Prescription Claims", title = "Count of Toal Claims by State for East North Central Region in 2017") + theme(axis.text.x = element_text(angle = 90))

```

State
Florida:
```{r}
#Florida:
state_FL <- combinediqvia %>%
  filter(nppes_provider_state == "FL")
#summary(state_FL)

#Total claims in general for generic_name
state_FL_total <- state_FL %>% 
  group_by(generic_name) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(10)

ggplot(state_FL_total, aes(x = reorder(generic_name, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Generic Antibiotic Name", y = "Total Prescription Claims", title = "Count of Top 10 Highest Prescribed Antibiotics in Florida 2017") + theme(axis.text.x = element_text(angle = 90))

#Total Claims for year 2017 (ge65)
state_FL_ge65 <- state_FL %>% 
  group_by(generic_name) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count_ge65)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(10)

ggplot(state_FL_ge65, aes(x = reorder(generic_name, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Generic Antibiotic Name", y = "Total Prescription Claims", title = "Count of Top 10 Highest Prescribed Antibiotics in Florida for 65+ in 2017") + theme(axis.text.x = element_text(angle = 90))

#What is the specialty distribution

state_FL_spec <- state_FL %>% 
  group_by(specialty_description) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count)) %>% 
  arrange(desc(totalprescriptioncount)) %>% 
  head(10)

ggplot(state_FL_spec, aes(x = reorder(specialty_description, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Prescriber Specialty", y = "Total Prescription Claims", title = "Count of Top 10 Highest Prescribers in 2017") + theme(axis.text.x = element_text(angle = 90))

state_FL_spec <- state_FL %>% 
  group_by(specialty_description) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count_ge65)) %>% 
  arrange(desc(totalprescriptioncount)) %>%
  head(5)

ggplot(state_FL_spec, aes(x = reorder(specialty_description, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Prescriber Specialty", y = "Total Prescription Claims", title = "Count of Top  Highest Prescribers for 65+ in 2017") + theme(axis.text.x = element_text(angle = 90))

#Dig deeper for ge65 and tigecycline
state_FL_tygecycline <- state_FL %>%
  filter(generic_name == "TIGECYCLINE") %>%
  group_by(specialty_description) %>% 
  summarise(totalprescriptioncount = sum(total_claim_count_ge65)) %>% 
  arrange(desc(totalprescriptioncount)) %>%
  head(10)

ggplot(state_FL_spec, aes(x = reorder(specialty_description, -totalprescriptioncount), y = totalprescriptioncount)) + geom_col() + labs(x = "Prescriber Specialty", y = "Total Prescription Claims", title = "Top Prescribers for Tigecycline for 65+ in Florida in 2017") + theme(axis.text.x = element_text(angle = 90))

```



```{r}

resistance_state <- read.csv("~/Documents/School/Smith Sem 7/Special Studies/PSP_Antibiotic_Resistance_Data/Resist_States.csv")

# 2) 
resistance_region <- read.csv("~/Documents/School/Smith Sem 7/Special Studies/PSP_Antibiotic_Resistance_Data/Resist_Regional.csv")

# 3)
resistance_national <- read.csv("~/Documents/School/Smith Sem 7/Special Studies/PSP_Antibiotic_Resistance_Data/Resist_National.csv")

```


#Medicaid:
##Quinolones/Fluoroquinolones antibiotic drugs:
```{r}
#Generic name of drug (Referenced GoodRx): Ciprofloxacin HCl, Ciprofloxacin, Ciprofloxacin/Hydrocortisone,
#Ciprofloxacin In 5 % Dextrose, Ciprofloxacin HCl/Dexameth, Ciprofloxacin Lactate, Ciprofloxacin/Ciprofloxa HCl, Ciprofloxacin HCl/Fluocinolone, Levofloxacin, Levofloxacin In Dextrose 5 %, Ofloxacin, Moxifloxacin HCl, Moxifloxacin-Sod.Chloride(Iso), Moxifloxacin/Sod.Ace,Sul/Water, Besifloxacin HCl, Delafloxacin Meglumine, Gatifloxacin

# Create a new data set with only drugs under the quinolones antibiotic class:
Medicaid_Quinolone <- Medicaid_SpendingUtilization %>%
  filter(GenericName == "Ciprofloxacin HCl"|
           GenericName == "Ciprofloxacin"|
           GenericName == "Ciprofloxacin/Hydrocortisone"|
           GenericName == "Ciprofloxacin In 5 % Dextrose"|
           GenericName == "Ciprofloxacin HCl/Dexameth"|
           GenericName == "Ciprofloxacin Lactate"|
           GenericName == "Ciprofloxacin/Ciprofloxa HCl"|
           GenericName == "Ciprofloxacin HCl/Fluocinolone"|
           GenericName == "Levofloxacin"|
           GenericName == "Levofloxacin In Dextrose 5 %"|
           GenericName == "Ofloxacin"|
           GenericName == "Moxifloxacin HCl"|
           GenericName == "Moxifloxacin-Sod.Chloride(Iso)"|
           GenericName == "Moxifloxacin/Sod.Ace,Sul/Water"|
           GenericName == "Besifloxacin HCl"|
           GenericName == "Delafloxacin Meglumine"|
           GenericName == "Gatifloxacin")
View(Medicaid_Quinolone)

# EDA to look at trends for spending:
ggplot(data = Medicaid_Quinolone, aes(x = Year, y = TotalSpending)) + geom_point()
ggplot(data = Medicaid_Quinolone, aes(x = Year, y = TotalClaims, col = GenericName)) + geom_jitter()
ggplot(data = Medicaid_Quinolone, aes(x = log10(TotalClaims))) + geom_histogram() + facet_wrap(~Year)
```

#Regional Resistance Data:
```{r}
# Refreshing Regional resistance data
Resist_Regional <- resistance_region %>%
  select(-Lower95CI, -Upper95CI, -PercentResistant)

#Resistance Trends by Region
Resist_Regional <- Resist_Regional %>%
  filter(EventYear != "All Years")

#Change data type
Resist_Regional$NumberTested <- as.numeric(as.character(Resist_Regional$NumberTested))
Resist_Regional$NumberResistant <- as.numeric(as.character(Resist_Regional$NumberResistant))
#Resist_Regional$PercentResistant <- as.numeric(as.character(Resist_Regional$PercentResistant))
Resist_Regional$AgeCategory <- as.character(Resist_Regional$AgeCategory)

# Inserting the average of NumberResistant and NumberTested:
Resist_Regional <- Resist_Regional %>%
  filter(NumberResistant != "Insufficient Data" & NumberResistant != "None Tested" & EventYear != "All Years")

# Plot to see trends in region:
#ggplot(data = Resist_Regional, aes(x = EventYear, y = PercentResistant, col = AgeCategory)) + geom_col()
#ggplot(data = Resist_Regional, aes(x = EventYear, y = PercentResistant)) + geom_col() + facet_wrap(~Region)

```

# Calculate Percent Resistant
```{r}
# Tidy format for Resist_Regional data and take out ALL HAIS and ALL AGES
Resist_Regional <- Resist_Regional %>%
  gather(MetricType, MetricNumber, NumberTested:NumberResistant) %>%
  filter(EventType != "All HAIs", AgeCategory != "All Ages")

# Plot NumberTested and NumberResistant Data
ggplot(data = Resist_Regional, 
       aes(x = EventYear, y = MetricNumber, fill = MetricType)) + 
  geom_col(position = position_dodge(width = 0.5)) + 
  facet_wrap(~Region)

# Regroup data for Calculated PercentResistant Data
Resist_Regional_CalculateResPercent <- Resist_Regional %>%
  group_by(Region, EventYear, MetricType) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

# Revert Dataset to Wide form
Wide_data_ResistPercent <- spread(Resist_Regional_CalculateResPercent,
                                  MetricType,
                                  TotalMetricNumber)
Wide_data_ResistPercent <- Wide_data_ResistPercent %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)

#Wide_data_ResistPercent <- melt(Resist_Regional_CalculateResPercent,
#                                id.vars = c("Region", "EventYear"),
#                                variable.name = "MetricType",
#                                value.name = "TotalMetricNumber")

#Wide_data_ResistPercent <- reshape(Resist_Regional_CalculateResPercent,
#                                   idvar = c("Region", "EventYear"),
#                                   timevar = "MetricType",
#                                   direction = "wide")

# Plot Percent Resistant Data
ggplot(data = Wide_data_ResistPercent, 
       aes(x = EventYear, y = Percent_Resistant)) + 
  geom_col() + 
  facet_wrap(~Region)

# Facet with Years
  
```

#Trying other variables: Age Category
```{r}
#Regroup Resist_Regional by AgeCategory:
Resist_Regional <- resistance_region %>%
  select(-Lower95CI, -Upper95CI, -PercentResistant)

#Resistance Trends by Region
Resist_Regional <- Resist_Regional %>%
  filter(NumberResistant != "Insufficient Data" & NumberResistant != "None Tested" & EventYear != "All Years")

#Change data type to numerical
Resist_Regional$NumberTested <- as.numeric(as.character(Resist_Regional$NumberTested))
Resist_Regional$NumberResistant <- as.numeric(as.character(Resist_Regional$NumberResistant))

# Tidy format for Resist_Regional data 
Resist_Regional <- Resist_Regional %>%
  gather(MetricType, MetricNumber, NumberTested:NumberResistant) %>%
  filter(EventType != "All HAIs", AgeCategory != "All Ages")

# Regroup with age and year
Resist_Regional_byAge <- Resist_Regional %>%
  group_by(Region, EventYear, MetricType, AgeCategory) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

# Revert Dataset to Wide form
Wide_AgeCategory <- spread(Resist_Regional_byAge,
                                  MetricType,
                                  TotalMetricNumber)
Wide_AgeCategory <- Wide_AgeCategory %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)

# Plot Percent Resistance by AgeCaetgory (bar):
ggplot(data = Wide_AgeCategory, 
       aes(x = EventYear, y = Percent_Resistant, fill = AgeCategory)) + 
  geom_col(position = "dodge") + 
  facet_wrap(~Region)
# Plot NumberTested by AgeCaetgory (bar):
ggplot(data = Wide_AgeCategory, 
       aes(x = EventYear, y = NumberTested, fill = AgeCategory)) + 
  geom_col(position = "dodge") +
  facet_wrap(~Region)

# Plot Percent Resistance by AgeCaetgory (line):
Resist_Regional_byAge <- Resist_Regional %>%
  group_by(EventYear, MetricType, AgeCategory) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

Wide_AgeCategory <- spread(Resist_Regional_byAge,
                                  MetricType,
                                  TotalMetricNumber)
Wide_AgeCategory <- Wide_AgeCategory %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)

Wide_AgeCategory <- Wide_AgeCategory %>%
  filter(Percent_Resistant != 0)

#ggplot(data = Wide_AgeCategory, 
#       aes(x = EventYear, y = Percent_Resistant, col = AgeCategory)) + 
#  geom_line() #Don't know why it's not plotting



```

#Trying out some statistical tests
```{r}
# Chi Square:
# categorical variables: Phenotype, Region, EventType, EventYear, EventCategory


#Regroup Resist_Regional by AgeCategory:
Resist_Regional <- resistance_region %>%
  select(-Lower95CI, -Upper95CI, -PercentResistant)

#Resistance Trends by Region
Resist_Regional <- Resist_Regional %>%
  filter(NumberResistant != "Insufficient Data" & NumberResistant != "None Tested" & EventYear != "All Years")

#Change data type to numerical
Resist_Regional$NumberTested <- as.numeric(as.character(Resist_Regional$NumberTested))
Resist_Regional$NumberResistant <- as.numeric(as.character(Resist_Regional$NumberResistant))

# Tidy format for Resist_Regional data 
Resist_Regional <- Resist_Regional %>%
  gather(MetricType, MetricNumber, NumberTested:NumberResistant) %>%
  filter(EventType != "All HAIs", AgeCategory != "All Ages")


#Rearrange
Resist_Regional_test <- Resist_Regional %>%
  group_by(Phenotype, Region, MetricType, AgeCategory) %>%
  summarize(TotalMetricNumber = sum(MetricNumber))

# Revert Dataset to Wide form
Wide_test <- spread(Resist_Regional_test,
                                  MetricType,
                                  TotalMetricNumber)
Wide_test <- Wide_test %>%
  mutate(Percent_Resistant = (NumberResistant/NumberTested)*100)


```

Merging Population and Age distrubution data:
```{r}
# importing age distrib data:
agedistrib_2011 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2011_agedistribution.csv")
agedistrib_2012 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2012_agedistribution.csv")
agedistrib_2013 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2013_agedistribution.csv")
agedistrib_2014 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2014_agedistribution.csv")
# importing population data:
pop_2011 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2011_populationct.csv") %>%
  select(-Total)
pop_2012 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2012_populationct.csv") %>%
  select(-Total)
pop_2013 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2013_populationct.csv") %>%
  select(-Total)
pop_2014 <- read.csv("~/Documents/GitHub/DoritLab_AntibioticTrends/Data/2014_populationct.csv") %>%
  select(-Total)

#Splitting up the regional
resistance_2011 <- resistance_state %>%
  filter(EventYear == 2011,
         AgeCategory != "All Ages") %>%
  select(-Lower95CI, -Upper95CI) %>%
  mutate(Location = recode(State, 
                        "AL" = "Alabama",
                        "AK" = "Alaska",
                        "AZ" = "Arizona",
                        "AR" = "Arkansas",
                        "CA" = "California",
                        "CO" = "Colorado",
                        "CT" = "Connecticut",
                        "DE" = "Delaware",
                        "DC" = "District Of Columbia",
                        "FL" = "Florida",
                        "GA" = "Georgia",
                        "HI" = "Hawaii",
                        "ID" = "Idaho",
                        "IL" = "Illinois",
                        "IN" = "Indiana",
                        "IA" = "Iowa",
                        "KS" = "Kansas",
                        "KY" = "Kentucky",
                        "LA" = "Louisiana",
                        "ME" = "Maine",
                        "MD" = "Maryland",
                        "MA" = "Massachusetts",
                        "MI" = "Michigan",
                        "MN" = "Minnesota",
                        "MS" = "Mississippi",
                        "MO" = "Missouri",
                        "MT" = "Montana",
                        "NE" = "Nebraska",
                        "NV" = "Nevada",
                        "NH" = "New Hampshire",
                        "NJ" = "New Jersey",
                        "NM" = "New Mexico",
                        "NY" = "New York",
                        "NC" = "North Carolina",
                        "ND" = "North Dakota",
                        "OH" = "Ohio",
                        "OK" = "Oklahoma",
                        "OR" = "Oregon",
                        "PA" = "Pennsylvania",
                        "RI" = "Rhode Island",
                        "SC" = "South Carolina",
                        "SD" = "South Dakota",
                        "TN" = "Tennessee",
                        "TX" = "Texas",
                        "UT" = "Utah",
                        "VT" = "Vermont",
                        "VA" = "Virginia",
                        "WA" = "Washington",
                        "WV" = "West Virginia",
                        "WI" = "Wisconsin",
                        "WY" = "Wyoming")) %>%
  select(-State, - PercentResistant)

# Rearrange pop_2011 and agedistrib_2011 to be tidy
pop_2011 <- pop_2011 %>%
  gather(AgeCategory, Population, Children.0.18:X65.)
agedistrib_2011 <- agedistrib_2011 %>%
  gather(AgeCategory, AgeDistribution, Children.0.18:X65.)

# Combining pop_2011 and agedistrib_2011
pop_2011 <- pop_2011 %>%
  left_join(agedistrib_2011, by = c("Location", "Year", "AgeCategory"))

# Regrouping AgeCategory to :
pop_2011 <- pop_2011 %>%
  mutate(AgeCategory1 = recode(AgeCategory, "Children.0.18" = "0-18",
                              "Adults.19.25" = "19-64",
                              "Adults.26.34" = "19-64",
                              "Adults.35.54" = "19-64",
                              "Adults.55.64" = "19-64",
                              "X65." = "65+")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1,
         EventYear = Year) %>%
  group_by(Location, EventYear, AgeCategory) %>%
  summarize(pop_count = sum(Population),
            agedistribution = sum(AgeDistribution))

#pop_2011[c("Location", "EventYear", "AgeCategory","Population", "AgeDistribution")] <- reordering failed

# rename resistance_2011 agecategory values
resistance_2011$NumberTested <- as.numeric(as.character(resistance_2011$NumberTested))
resistance_2011$NumberResistant <- as.numeric(as.character(resistance_2011$NumberResistant))

resistance_2011 <- resistance_2011 %>%
  mutate(AgeCategory1 = recode(AgeCategory, 
                              "<1" = "0-18",
                              " 1-18" = "0-18")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1) %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, NumberTested, NumberResistant) %>%
  summarize(numberTested = sum(NumberTested),
            numberResistant = sum(NumberResistant))

resistance_2011 <- resistance_2011 %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, numberTested, numberResistant) %>%
  select(-NumberResistant, -NumberTested)


# merging pop_2011 to resistance_2011:
resistance_2011$EventYear <- as.character(resistance_2011$EventYear)
pop_2011$EventYear <- as.character(pop_2011$EventYear)

resistance_2011 <- resistance_2011 %>%
  left_join(pop_2011, by = c("Location", "EventYear", "AgeCategory"))

```

```{r}
## YEAR 2012

resistance_2012 <- resistance_state %>%
  filter(EventYear == 2012,
         AgeCategory != "All Ages") %>%
  select(-Lower95CI, -Upper95CI) %>%
  mutate(Location = recode(State, 
                        "AL" = "Alabama",
                        "AK" = "Alaska",
                        "AZ" = "Arizona",
                        "AR" = "Arkansas",
                        "CA" = "California",
                        "CO" = "Colorado",
                        "CT" = "Connecticut",
                        "DE" = "Delaware",
                        "DC" = "District Of Columbia",
                        "FL" = "Florida",
                        "GA" = "Georgia",
                        "HI" = "Hawaii",
                        "ID" = "Idaho",
                        "IL" = "Illinois",
                        "IN" = "Indiana",
                        "IA" = "Iowa",
                        "KS" = "Kansas",
                        "KY" = "Kentucky",
                        "LA" = "Louisiana",
                        "ME" = "Maine",
                        "MD" = "Maryland",
                        "MA" = "Massachusetts",
                        "MI" = "Michigan",
                        "MN" = "Minnesota",
                        "MS" = "Mississippi",
                        "MO" = "Missouri",
                        "MT" = "Montana",
                        "NE" = "Nebraska",
                        "NV" = "Nevada",
                        "NH" = "New Hampshire",
                        "NJ" = "New Jersey",
                        "NM" = "New Mexico",
                        "NY" = "New York",
                        "NC" = "North Carolina",
                        "ND" = "North Dakota",
                        "OH" = "Ohio",
                        "OK" = "Oklahoma",
                        "OR" = "Oregon",
                        "PA" = "Pennsylvania",
                        "RI" = "Rhode Island",
                        "SC" = "South Carolina",
                        "SD" = "South Dakota",
                        "TN" = "Tennessee",
                        "TX" = "Texas",
                        "UT" = "Utah",
                        "VT" = "Vermont",
                        "VA" = "Virginia",
                        "WA" = "Washington",
                        "WV" = "West Virginia",
                        "WI" = "Wisconsin",
                        "WY" = "Wyoming")) %>%
  select(-State, - PercentResistant)

pop_2012 <- pop_2012 %>%
  gather(AgeCategory, Population, Children.0.18:X65.)
agedistrib_2012 <- agedistrib_2012 %>%
  gather(AgeCategory, AgeDistribution, Children.0.18:X65.)

pop_2012 <- pop_2012 %>%
  left_join(agedistrib_2012, by = c("Location", "Year", "AgeCategory"))

pop_2012 <- pop_2012 %>%
  mutate(AgeCategory1 = recode(AgeCategory, "Children.0.18" = "0-18",
                              "Adults.19.25" = "19-64",
                              "Adults.26.34" = "19-64",
                              "Adults.35.54" = "19-64",
                              "Adults.55.64" = "19-64",
                              "X65." = "65+")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1,
         EventYear = Year) %>%
  group_by(Location, EventYear, AgeCategory) %>%
  summarize(pop_count = sum(Population),
            agedistribution = sum(AgeDistribution))

resistance_2012$NumberTested <- as.numeric(as.character(resistance_2012$NumberTested))
resistance_2012$NumberResistant <- as.numeric(as.character(resistance_2012$NumberResistant))

resistance_2012 <- resistance_2012 %>%
  mutate(AgeCategory1 = recode(AgeCategory, 
                              "<1" = "0-18",
                              " 1-18" = "0-18")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1) %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, NumberTested, NumberResistant) %>%
  summarize(numberTested = sum(NumberTested),
            numberResistant = sum(NumberResistant))

resistance_2012 <- resistance_2012 %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, numberTested, numberResistant) %>%
  select(-NumberResistant, -NumberTested)


resistance_2012$EventYear <- as.character(resistance_2012$EventYear)
pop_2012$EventYear <- as.character(pop_2012$EventYear)

resistance_2012 <- resistance_2012 %>%
  left_join(pop_2012, by = c("Location", "EventYear", "AgeCategory"))

## YEAR 2013


resistance_2013 <- resistance_state %>%
  filter(EventYear == 2013,
         AgeCategory != "All Ages") %>%
  select(-Lower95CI, -Upper95CI) %>%
  mutate(Location = recode(State, 
                        "AL" = "Alabama",
                        "AK" = "Alaska",
                        "AZ" = "Arizona",
                        "AR" = "Arkansas",
                        "CA" = "California",
                        "CO" = "Colorado",
                        "CT" = "Connecticut",
                        "DE" = "Delaware",
                        "DC" = "District Of Columbia",
                        "FL" = "Florida",
                        "GA" = "Georgia",
                        "HI" = "Hawaii",
                        "ID" = "Idaho",
                        "IL" = "Illinois",
                        "IN" = "Indiana",
                        "IA" = "Iowa",
                        "KS" = "Kansas",
                        "KY" = "Kentucky",
                        "LA" = "Louisiana",
                        "ME" = "Maine",
                        "MD" = "Maryland",
                        "MA" = "Massachusetts",
                        "MI" = "Michigan",
                        "MN" = "Minnesota",
                        "MS" = "Mississippi",
                        "MO" = "Missouri",
                        "MT" = "Montana",
                        "NE" = "Nebraska",
                        "NV" = "Nevada",
                        "NH" = "New Hampshire",
                        "NJ" = "New Jersey",
                        "NM" = "New Mexico",
                        "NY" = "New York",
                        "NC" = "North Carolina",
                        "ND" = "North Dakota",
                        "OH" = "Ohio",
                        "OK" = "Oklahoma",
                        "OR" = "Oregon",
                        "PA" = "Pennsylvania",
                        "RI" = "Rhode Island",
                        "SC" = "South Carolina",
                        "SD" = "South Dakota",
                        "TN" = "Tennessee",
                        "TX" = "Texas",
                        "UT" = "Utah",
                        "VT" = "Vermont",
                        "VA" = "Virginia",
                        "WA" = "Washington",
                        "WV" = "West Virginia",
                        "WI" = "Wisconsin",
                        "WY" = "Wyoming")) %>%
  select(-State, - PercentResistant)

pop_2013 <- pop_2013 %>%
  gather(AgeCategory, Population, Children.0.18:X65.)
agedistrib_2013 <- agedistrib_2013 %>%
  gather(AgeCategory, AgeDistribution, Children.0.18:X65.)

pop_2013 <- pop_2013 %>%
  left_join(agedistrib_2013, by = c("Location", "Year", "AgeCategory"))

pop_2013 <- pop_2013 %>%
  mutate(AgeCategory1 = recode(AgeCategory, "Children.0.18" = "0-18",
                              "Adults.19.25" = "19-64",
                              "Adults.26.34" = "19-64",
                              "Adults.35.54" = "19-64",
                              "Adults.55.64" = "19-64",
                              "X65." = "65+")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1,
         EventYear = Year) %>%
  group_by(Location, EventYear, AgeCategory) %>%
  summarize(pop_count = sum(Population),
            agedistribution = sum(AgeDistribution))

resistance_2013$NumberTested <- as.numeric(as.character(resistance_2013$NumberTested))
resistance_2013$NumberResistant <- as.numeric(as.character(resistance_2013$NumberResistant))

resistance_2013 <- resistance_2013 %>%
  mutate(AgeCategory1 = recode(AgeCategory, 
                              "<1" = "0-18",
                              " 1-18" = "0-18")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1) %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, NumberTested, NumberResistant) %>%
  summarize(numberTested = sum(NumberTested),
            numberResistant = sum(NumberResistant))

resistance_2013 <- resistance_2013 %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, numberTested, numberResistant) %>%
  select(-NumberResistant, -NumberTested)


resistance_2013$EventYear <- as.character(resistance_2013$EventYear)
pop_2013$EventYear <- as.character(pop_2013$EventYear)

resistance_2013 <- resistance_2013 %>%
  left_join(pop_2013, by = c("Location", "EventYear", "AgeCategory"))

## YEAR 2014


resistance_2014 <- resistance_state %>%
  filter(EventYear == 2014,
         AgeCategory != "All Ages") %>%
  select(-Lower95CI, -Upper95CI) %>%
  mutate(Location = recode(State, 
                        "AL" = "Alabama",
                        "AK" = "Alaska",
                        "AZ" = "Arizona",
                        "AR" = "Arkansas",
                        "CA" = "California",
                        "CO" = "Colorado",
                        "CT" = "Connecticut",
                        "DE" = "Delaware",
                        "DC" = "District Of Columbia",
                        "FL" = "Florida",
                        "GA" = "Georgia",
                        "HI" = "Hawaii",
                        "ID" = "Idaho",
                        "IL" = "Illinois",
                        "IN" = "Indiana",
                        "IA" = "Iowa",
                        "KS" = "Kansas",
                        "KY" = "Kentucky",
                        "LA" = "Louisiana",
                        "ME" = "Maine",
                        "MD" = "Maryland",
                        "MA" = "Massachusetts",
                        "MI" = "Michigan",
                        "MN" = "Minnesota",
                        "MS" = "Mississippi",
                        "MO" = "Missouri",
                        "MT" = "Montana",
                        "NE" = "Nebraska",
                        "NV" = "Nevada",
                        "NH" = "New Hampshire",
                        "NJ" = "New Jersey",
                        "NM" = "New Mexico",
                        "NY" = "New York",
                        "NC" = "North Carolina",
                        "ND" = "North Dakota",
                        "OH" = "Ohio",
                        "OK" = "Oklahoma",
                        "OR" = "Oregon",
                        "PA" = "Pennsylvania",
                        "RI" = "Rhode Island",
                        "SC" = "South Carolina",
                        "SD" = "South Dakota",
                        "TN" = "Tennessee",
                        "TX" = "Texas",
                        "UT" = "Utah",
                        "VT" = "Vermont",
                        "VA" = "Virginia",
                        "WA" = "Washington",
                        "WV" = "West Virginia",
                        "WI" = "Wisconsin",
                        "WY" = "Wyoming")) %>%
  select(-State, - PercentResistant)

pop_2014 <- pop_2014 %>%
  gather(AgeCategory, Population, Children.0.18:X65.)
agedistrib_2014 <- agedistrib_2014 %>%
  gather(AgeCategory, AgeDistribution, Children.0.18:X65.)

pop_2014 <- pop_2014 %>%
  left_join(agedistrib_2014, by = c("Location", "Year", "AgeCategory"))

pop_2014 <- pop_2014 %>%
  mutate(AgeCategory1 = recode(AgeCategory, "Children.0.18" = "0-18",
                              "Adults.19.25" = "19-64",
                              "Adults.26.34" = "19-64",
                              "Adults.35.54" = "19-64",
                              "Adults.55.64" = "19-64",
                              "X65." = "65+")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1,
         EventYear = Year) %>%
  group_by(Location, EventYear, AgeCategory) %>%
  summarize(pop_count = sum(Population),
            agedistribution = sum(AgeDistribution))

resistance_2014$NumberTested <- as.numeric(as.character(resistance_2014$NumberTested))
resistance_2014$NumberResistant <- as.numeric(as.character(resistance_2014$NumberResistant))

resistance_2014 <- resistance_2014 %>%
  mutate(AgeCategory1 = recode(AgeCategory, 
                              "<1" = "0-18",
                              " 1-18" = "0-18")) %>%
  select(-AgeCategory) %>%
  rename(AgeCategory = AgeCategory1) %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, NumberTested, NumberResistant) %>%
  summarize(numberTested = sum(NumberTested),
            numberResistant = sum(NumberResistant))

resistance_2014 <- resistance_2014 %>%
  group_by(Phenotype, EventType, Location, EventYear, 
           AgeCategory, numberTested, numberResistant) %>%
  select(-NumberResistant, -NumberTested)


resistance_2014$EventYear <- as.character(resistance_2014$EventYear)
pop_2014$EventYear <- as.character(pop_2014$EventYear)

resistance_2014 <- resistance_2014 %>%
  left_join(pop_2014, by = c("Location", "EventYear", "AgeCategory"))

```

MERGING 2011-2014 Data
```{r}
#merging rows

resistance_total <- rbind(resistance_2011, resistance_2012,
                          resistance_2013, resistance_2014)

```


Multiple Imputation:
```{r}
# removing all HAIs:
resistance_total <- resistance_total %>%
  filter(EventType != "All HAIs")

resistance_total$Phenotype <- as.character(resistance_total$Phenotype)
resistance_total$EventType <- as.character(resistance_total$EventType)
resistance_total$Location <- as.character(resistance_total$Location)
resistance_total$EventYear <- as.character(resistance_total$EventYear)
resistance_total$AgeCategory <- as.character(resistance_total$AgeCategory)

# recode state to abbrev
resistance_total <- resistance_total %>%
  mutate(State = recode(Location, 
                           "Alabama" = "AL",
                           "Alaska" = "AK",
                           "Arizona" = "AZ",
                           "Arkansas" = "AR",
                           "California" = "CA",
                           "Colorado" = "CO",
                           "Connecticut" = "CT",
                           "Delaware" = "DE",
                           "District Of Columbia" = "DC",
                           "Florida" = "FL",
                           "Georgia" = "GA",
                           "Hawaii" = "HI",
                           "Idaho" = "ID",
                           "Illinois" = "IL",
                           "Indiana" = "IN", 
                           "Iowa" = "IA",
                           "Kansas" = "KS",
                           "Kentucky" = "KY",
                           "Louisiana" = "LA", 
                           "Maine" = "ME",
                           "Maryland" = "MD",
                           "Massachusetts" = "MA",
                           "Michigan" = "MI",
                           "Minnesota" = "MN",
                           "Mississippi" = "MS",
                           "Missouri" = "MO",
                           "Montana" = "MT",
                           "Nebraska" = "NE",
                           "Nevada" = "NV",
                           "New Hampshire" = "NH",
                           "New Jersey" = "NJ",
                           "New Mexico" = "NM",
                           "New York" = "NY",
                           "North Carolina" = "NC",
                           "North Dakota" = "ND",
                           "Ohio" = "OH",
                           "Oklahoma" = "OK",
                           "Oregon" = "OR",
                           "Pennsylvania" = "PA",
                           "Rhode Island" = "RI",
                           "South Carolina" = "SC",
                           "South Dakota" = "SD",
                           "Tennessee" = "TN",
                           "Texas" = "TX",
                           "Utah" = "UT",
                           "Vermont" = "VT",
                           "Virginia" = "VA",
                           "Washington" = "WA",
                           "West Virginia" = "WV",
                           "Wisconsin" = "WI",
                           "Wyoming" = "WY")) %>%
  mutate(Region = ifelse(State %in% c("IL", "IN", "MI", "OH", "WI"), "East North Central",
                         ifelse(State %in% c("AL", "KY", "MS", "TN"), "East South Central",
                                ifelse(State %in% c("NJ", "NY", "PA"), "Middle Atlantic",
                                       ifelse(State %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY"), "Mountain",
                                              ifelse(State %in% c("CT", "ME", "MA", "NH", "RI", "VT"), "New England",
                                                     ifelse(State %in% c("AK", "CA", "HI", "OR", "WA"), "Pacific",
                                                            ifelse(State %in% c("DE", "DC", "FL", "GA", "MD", "NC", "SC", "VA", "WV"), "South Atlantic",
                                                                   ifelse(State %in% c("IA", "KS", "MN", "MO", "NE", "ND", "SD"), "West North Central",
                                                                          ifelse(State %in% c("AR", "LA", "OK", "TX"), "West South Central", "Region Undefined"))))))))))

# reordering
col_order <- c("Phenotype", "EventType", "Location", "State", "Region", "EventYear", "AgeCategory", "numberTested", "numberResistant", "pop_count", "agedistribution")

resistance_total <- resistance_total[, col_order]

# Finding the means of numberTested and number Resistant by REGION and AGE:

summary_region_mean <- resistance_total %>%
  group_by(Region, AgeCategory) %>%
  summarize(AvgNumTested = mean(numberTested, na.rm = TRUE),
            AvgNumResistant = mean(numberResistant, na.rm = TRUE))



# With plyr package:
plyr_resistance_total <- ddply(resistance_total,~ Phenotype  +  EventType + Location + EventYear + AgeCategory,
      summarise,average=mean(numberTested)) 

```












